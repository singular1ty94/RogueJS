function ABILITY_HEAL(a){a.restoreHP(20)}function ABILITY_MAJOR_HEAL(a){a.restoreHP(40)}function ABILITY_DIVINE_HEAL(a){a.restoreHP(9999)}function ABILITY_LEARN_MINOR(a){a.gainXP(15)}function ABILITY_LEARN_MAJOR(a){a.gainXP(50)}function ABILITY_LEARN_DIVINE(a){a.gainXP(100)}function ABILITY_NOTHING(a){MessageLog("This does nothing.")}function PASSIVE_GAIN_MINOR_HEAL(a){RogueJS.player.addPassive(PASSIVE_MINOR_HEAL)?(MessageLog("The %c{"+Colors.PURPLE+"}shard%c{} cuts your hand. Ancient %c{"+Colors.PURPLE+"}magic%c{} rushes through your veins!"),MessageLog("You now %c{"+Colors.HEALTH_LIGHT+"}regenerate health%c{}.")):MessageLog("You are already %c{"+Colors.HEALTH_LIGHTBLOOD+"}regenerating health%c{}.")}function PASSIVE_GAIN_MINOR_POISON(a){RogueJS.player.addPassive(PASSIVE_MINOR_POISON)?(MessageLog("The %c{"+Colors.PURPLE+"}shard%c{} cuts your hand. Ancient %c{"+Colors.PURPLE+"}magic%c{} rushes through your veins!"),MessageLog("You are %c{"+Colors.BLOOD+"}poisoned%c{}!")):MessageLog("You are already %c{"+Colors.BLOOD+"}poisoned%c{}.")}function ABILITY_WEAPON_BASIC(a){var b=["Wooden","Chipped","Rusted","Bent","Damaged","Broken","Makeshift"],c=["Sword","Club","Spear","Mace","Axe","Dagger","Knife"],d="#d77",e="/",f=getRandom(3,8),g=getRandom(25,60),h=b[getRandom(0,b.length)]+" "+c[getRandom(0,c.length)];MessageLog("You wield the %c{"+Colors.BRONZE+"}"+h+"%c{}!");var c=new Weapon(h,e,d,f,g,null,null);a.changeWeapon(c)}function ABILITY_WEAPON_DECENT(a){var b=["Solid","Reliable","Decent","Adequate","Common","Standard"],c=["Sword","Katana","Spear","Mace","Battle-Axe","Dagger"],d="#d77",e="/",f=getRandom(12,20),g=getRandom(80,150),h=b[getRandom(0,b.length)]+" "+c[getRandom(0,c.length)];MessageLog("You wield the %c{"+Colors.GOLD+"}"+h+"%c{}!");var c=new Weapon(h,e,d,f,g,null,null);a.changeWeapon(c)}function ABILITY_WEAPON_EXCELLENT(a){var b=["Stunning","Honed","Superb","Shattering","Gods-Borne"],c=["Sword","Katana","Spear","Mace","Battle-Axe","Flail"],d="#d77",e="/",f=getRandom(35,45),g=getRandom(80,150),h=b[getRandom(0,b.length)]+" "+c[getRandom(0,c.length)];MessageLog("You wield the %c{"+Colors.GOLD+"}"+h+"%c{}!");var c=new Weapon(h,e,d,f,g,null,null);a.changeWeapon(c)}function getRandom(a,b){return Math.floor(Math.random()*(b-a)+a)}function GetObjectAtTile(a,b){if(RogueJS.player.getX()==a&&RogueJS.player.getY()==b)return RogueJS.player;for(var c=0;c<Entities.length;c++)if(Entities[c]._x==a&&Entities[c]._y==b)return Entities[c]}function GetEnemyAtTile(a,b){for(var c=0;c<Entities.length;c++)if(Entities[c]._x==a&&Entities[c]._y==b&&(Entities[c]instanceof Actor||Entities[c]instanceof Player))return Entities[c]}function attackTile(a,b,c){if(IsOccupied(b,c)){var d=GetEnemyAtTile(b,c);d.damageHP(a.getDamage());var e=a.getName()+" attacks "+d.getName()+" for "+a.getDamage()+" %c{red}damage!";if(MessageLog(e),getRandom(0,100)<=60&&bloodSplatter(b,c,getRandom(0,7)),d.isDead()&&d instanceof Actor){var f=Entities.indexOf(d);RogueJS.scheduler.remove(d),Entities.splice(f,1),RogueJS.player.gainXP(d.getXP());var g=new Item(d.getX(),d.getY(),"Bloody Corpse","%",Colors.BLOOD,ABILITY_NOTHING);Entities.unshift(g),recalculateMap();var e="The "+d.getName()+" %c{red}is dead!";MessageLog(e)}}}function bloodSplatter(a,b,c){if("Blood"!=GetObjectAtTile(a,b).getName()){switch(dirs=[],c){case 0:dirs=[a-1,b-1];break;case 1:dirs=[a,b-1];break;case 2:dirs=[a+1,b-1];break;case 3:dirs=[a+1,b];break;case 4:dirs=[a+1,b+1];break;case 5:dirs=[a,b+1];break;case 6:dirs=[a-1,b+1];break;case 7:dirs=[a-1,b]}var d=new Item(dirs[0],dirs[1],"Blood","",Colors.BLOOD,ABILITY_NOTHING);Entities.unshift(d)}}function getCircle(a,b,c){var d,e,f,g=[];d=ROT.DIRS[4],e=2,f=[-1,1];for(var h=a+f[0]*c,i=b+f[1]*c,j=0;j<d.length;j++)for(var k=0;k<c*e;k++)g.push([h,i]),h+=d[j][0],i+=d[j][1];return g}function bloomEffect(a,b,c,d){bloomTiles=getCircle(a,b,c);for(var e=0;e<bloomTiles.length;e++)RogueJS.display.draw(bloomTiles[e][0],bloomTiles[e][1],"",Colors.WHITE,d);try{RogueJS.engine.lock(),setTimeout(tryUnlock,100)}catch(a){}}function tryUnlock(){try{RogueJS.engine.unlock()}catch(a){}}function checkUnderFoot(a,b){if(RogueJS.player)for(var c=0;c<Entities.length;c++)if(Entities[c]._x==a&&Entities[c]._y==b&&Entities[c]instanceof Item)return Entities[c];return!1}function MessageLog(a){Messages.unshift(a),RogueJS.msgLog.clear(),Messages.length>5&&Messages.splice(5,Messages.length-5);for(var b=0;b<Messages.length;b++)RogueJS.msgLog.drawText(1,b,Messages[b])}function UpdateHUD(){if(RogueJS.hud.clear(),RogueJS.player){curHealth="HP ("+RogueJS.player.getHP()+"/"+RogueJS.player.getMaxHP()+")",curHealthWidth=curHealth.length+2,drawBar(1,0,curHealthWidth,RogueJS.player.getMaxHP(),RogueJS.player.getHP(),Colors.HEALTH_LIGHT,Colors.HEALTH_DARK,curHealth),curXP="XP ("+RogueJS.player.getXP()+"/"+RogueJS.player.getNextXP()+") | Lv "+RogueJS.player.getLevel(),curXPWidth=curXP.length+2,drawBar(curHealthWidth+2,0,curXPWidth,RogueJS.player.getNextXP(),RogueJS.player.getXP(),Colors.XP_LIGHT,Colors.XP_DARK,curXP),curWeapon=RogueJS.player._weapon.getName()+" ("+RogueJS.player._weapon.getDamage()+" dmg)",curWeaponWidth=curWeapon.length+2,drawBar(curHealthWidth+curXPWidth+3,0,curWeaponWidth,1,1,Colors.ORANGE_GOLD,Colors.ORANGE_GOLD,curWeapon),passive="";for(var a=0;a<RogueJS.player.getPassives().length;a++)passive=passive+RogueJS.player.getPassives()[a].symbol+" ";RogueJS.hud.drawText(curHealthWidth+curXPWidth+curWeaponWidth+4,0,passive)}}function lightPasses(a,b){var c=a+","+b;return c in RogueJSData&&0==RogueJSData[c]}function reflectivity(a,b){return 1==RogueJSData[a+","+b]?.3:0}function flashScreen(){$("#RogueFlash").show(),$("#RogueFlash").addClass("flash"),$("#RogueCanvas").hide(),setTimeout(function(){$("#RogueFlash").removeClass("flash"),$("#RogueFlash").hide(),$("#RogueCanvas").show()},250)}function canvasClick(a){var b=RogueJS.display.eventToPosition(a),c=GetObjectAtTile(b[0],b[1]);c&&IsInFOV(b[0],b[1])?MessageLog("You see a %c{#007dcc}"+c.getName()+"%c{}."):!c&&IsInFOV(b[0],b[1])?MessageLog("There's nothing there."):IsInFOV(b[0],b[1])||MessageLog("You can't see there.")}var Colors={FOV_WALL:"#595959",FOV_FLOOR:"#404040",DISCOVERED_WALL:"#101010",DISCOVERED_FLOOR:"#070707",HEALTH_DARK:"#145214",HEALTH_LIGHT:"#2eb82e",XP_DARK:"#4d004d",XP_LIGHT:"#800080",GOBLIN_SCOUT:"#0d1a26",GOBLIN_GREEN:"#009933",GOBLIN_GREEN_DARK:"#003311",BLACK:"#000000",ORANGE_GOLD:"#b37700",WHITE:"#ffffff",BLOOD:"#660000",GOLD:"#cca300",BRONZE:"#bf8040",PURPLE:"#8000ff",BRIGHT_GOLD:"#ffde23"},items=[Treasure={char:"#",color:Colors.ORANGE_GOLD,name:"Plain Chest",ability:ABILITY_WEAPON_BASIC,weighting:{common:[1,3],uncommon:[4,6]}},TreasureGold={char:"#",color:Colors.GOLD,name:"Metal Chest",ability:ABILITY_WEAPON_DECENT,weighting:{rare:[2,3],uncommon:[4,5],common:[6,8]}},TreasureGold={char:"#",color:Colors.BRIGHT_GOLD,name:"Golden Chest",ability:ABILITY_WEAPON_EXCELLENT,weighting:{uncommon:[7,8],common:[9,10]}},Shard={char:"o",color:Colors.PURPLE,name:"Strange Shard of Glass",ability:PASSIVE_GAIN_MINOR_HEAL,weighting:{rare:[1,4]}},Shard={char:"o",color:Colors.PURPLE,name:"Strange Shard of Glass",ability:PASSIVE_GAIN_MINOR_POISON,weighting:{rare:[1,4]}},Bones={char:"%",color:Colors.WHITE,name:"Skeleton",ability:ABILITY_NOTHING,weighting:{common:[1,99]}},MinorFlask={char:":",color:"#33cc33",name:"Minor Flask",ability:ABILITY_HEAL,weighting:{frequent:[1,3]}},MajorFlask={char:":",color:"#4da500",name:"Minor Flask",ability:ABILITY_MAJOR_HEAL,weighting:{common:[4,7]}},DivineFlask={char:":",color:"#7301ba",name:"Tears of a God",ability:ABILITY_DIVINE_HEAL,weighting:{common:[8,10]}},LearnBook={char:"[",color:"#cc0000",name:"Small Book",ability:ABILITY_LEARN_MINOR,weighting:{common:[2,3],uncommon:[4,5]}},LearnBookMajor={char:"[",color:"#ba3c01",name:"Dusty Tome",ability:ABILITY_LEARN_MAJOR,weighting:{uncommon:[3,4],common:[5,7]}},LearnBookDivine={char:"[",color:"#910063",name:"Knowledge of the Gods",ability:ABILITY_LEARN_DIVINE,weighting:{uncommon:[5,6],common:[7,10]}}],weapons={playerWeapon:{name:"Broken Sword",color:"#777",char:"/",dmg:3,price:34}},monsters=[WatcherOfTheAbyss={char:"W",color:"#00748e",name:"Watcher of the Abyss",maxHP:35,XP:115,range:99,weapon:{name:"Abyss Tentacle",color:"#6210ff",char:"/",dmg:20,price:90},weighting:{uncommon:[8,9]}},Goblin={char:"g",color:Colors.GOBLIN_GREEN,name:"Goblin",maxHP:6,XP:7,range:4,weapon:{name:"Dagger",color:"#777",char:"/",dmg:2,price:60},weighting:{common:[1,3]}},Goblin_Soldier={char:"G",color:Colors.GOBLIN_GREEN_DARK,name:"Goblin Soldier",maxHP:12,XP:15,range:5,weapon:{name:"Scimitar",color:"#6210ff",char:"/",dmg:5,price:90},weighting:{common:[2,3],rare:[1,1]}},CaptiveTroll={char:"T",color:"#4d9e8d",name:"Captive Troll",maxHP:35,XP:32,range:4,weapon:{name:"Fists",color:"#777",char:"/",dmg:12,price:60},weighting:{uncommon:[3,3],rare:[2,2]}},BloodFly={char:"o",color:"#c12600",name:"Bloodfly",maxHP:4,XP:3,range:16,weapon:{name:"Fly Bite",color:"#777",char:"/",dmg:2,price:60},weighting:{frequent:[1,2]}},Demon_Spawn={char:"d",color:"#d60000",name:"Demon Spawn",maxHP:27,XP:25,range:6,weapon:{name:"Claws",color:"#6210ff",char:"/",dmg:15,price:90},weighting:{frequent:[4,6]}},Demon_Swordsman={char:"d",color:"#d60000",name:"Demon Kixa",maxHP:35,XP:30,range:5,weapon:{name:"Blade",color:"#6210ff",char:"/",dmg:22,price:90},weighting:{common:[4,6]}},Demon_Elite={char:"x",color:"#992121",name:"Demon Xaigon",maxHP:50,XP:45,range:7,weapon:{name:"Demonic Blade",color:"#6210ff",char:"/",dmg:20,price:90},weighting:{uncommon:[4,4],common:[5,8]}}],PASSIVE_MINOR_HEAL={symbol:"%c{"+Colors.HEALTH_LIGHT+"}HP+%c{}",fire:function(a){getRandom(0,100)<=20&&(a._HP+=1),a._HP>=a._MaxHP&&(a._HP=a._MaxHP)}},PASSIVE_MINOR_POISON={symbol:this.symbol="%c{"+Colors.PURPLE+"}HP-%c{}",fire:function(a){getRandom(0,100)<=20&&(a._HP-=1),a._HP<=0&&RogueJS.postmortem()}},Actor=function(a,b,c,d,e,f,g,h,i){this._x=a,this._y=b,this._char=c,this._color=d,this._name=e,this._maxHP=f,this._HP=this._maxHP,this._XP=g,this._range=h,this._weapon=new Weapon(i.name,i.char,i.color,i.dmg,i.price),this._draw=function(){if(IsInFOV(this._x,this._y)||RogueJS.player&&RogueJS.player.seeEnemies)RogueJS.display.draw(this._x,this._y,this._char,this._color,RogueJSLight[this._x+","+this._y]);else if(0==RogueJS.discovered[this._x+","+this._y])RogueJS.display.draw(this._x,this._y,"",RogueJSLight[this._x+","+this._y],RogueJSLight[this._x+","+this._y]);else{RogueJSData[this._x+","+this._y]?Colors.DISCOVERED_WALL:Colors.DISCOVERED_FLOOR;RogueJS.display.draw(this._x,this._y,"",RogueJSLight[this._x+","+this._y],RogueJSLight[this._x+","+this._y])}},this.act=function(){if(RogueJS.player){RogueJS.engine.lock();var a=RogueJS.player.getX(),b=RogueJS.player.getY(),c=function(a,b){return 0===RogueJSData[a+","+b]},d=new ROT.Path.Dijkstra(a,b,c),e=[],f=function(a,b){e.push([a,b])};d.compute(this._x,this._y,f),e.shift(),e.length<=1?attackTile(this,RogueJS.player.getX(),RogueJS.player.getY()):IsOccupied(e[0][0],e[0][1])||e.length<=this._range&&(a=e[0][0],b=e[0][1],RogueJS.display.draw(this._x,this._y,RogueJS.map[this._x+","+this._y]),this._x=a,this._y=b,this._draw()),recalculateMap(),RogueJS.engine.unlock()}else RogueJS.display.draw(this._x,this._y,RogueJS.map[this._x+","+this._y]),this._x=this._x,this._y=this._y,this._draw()},this.getX=function(){return this._x},this.getY=function(){return this._y},this.getXP=function(){return this._XP},this.getName=function(){return this._name},this.getDamage=function(){return this._weapon.getDamage()},this.damageHP=function(a){this._HP-=a},this.restoreHP=function(a){this._HP+=a,this._HP>this._MaxHP&&(this._HP=this._MaxHP)},this.isDead=function(){return this._HP<=0},RogueJS.scheduler.add(this,!0)},Item=function(a,b,c,d,e,f){this._x=a,this._y=b,this._char=d,this._color=e,this._name=c,this._AbilityCallback=f,this._draw=function(a){if(IsInFOV(this._x,this._y)||RogueJS.player&&RogueJS.player.seeItems)if("Blood"==this._name||"Bloody Corpse"==this._name){var b="Blood"==this._name?RogueJSLight[this._x+","+this._y]:Colors.WHITE;RogueJS.display.draw(this._x,this._y,this._char,b,this._color)}else RogueJS.display.draw(this._x,this._y,this._char,this._color,RogueJSLight[this._x+","+this._y]);else 0==RogueJS.discovered[this._x+","+this._y]?RogueJS.display.draw(this._x,this._y,"",RogueJSLight[this._x+","+this._y],RogueJSLight[this._x+","+this._y]):RogueJS.display.draw(this._x,this._y,"",RogueJSLight[this._x+","+this._y],RogueJSLight[this._x+","+this._y])},this.act=function(){},this.getX=function(){return this._x},this.getY=function(){return this._y},this.getName=function(){return this._name},this.getChar=function(){return this._char},this.getPrice=function(){return this._price},this.useAbility=function(a){this._AbilityCallback(a)},RogueJS.scheduler.add(this)},Player=function(a,b){this._x=a,this._y=b,this._MaxHP=30,this._HP=this._MaxHP,this._level=1,this._XP=0,this._NextXP=30,this._draw(),this._name="Player",this._weapon=new Weapon(weapons.playerWeapon.name,weapons.playerWeapon.char,weapons.playerWeapon.color,weapons.playerWeapon.dmg,weapons.playerWeapon.price),this.seeItems=!1,this.seeEnemies=!1,this._passives=[],this.addPassive=function(a){for(var b=0;b<this._passives.length;b++)if(a==this._passives[b])return!1;return this._passives.unshift(a),!1},this.removePassive=function(a){for(var b=0;b<this._passives.length;b++)if(a==this._passives[b])return this._passives.splice(b,1),!0;return!1},this.getPassives=function(){return this._passives},this.firePassives=function(){for(var a=0;a<this._passives.length;a++)this._passives[a].fire(this)},this.getName=function(){return this._name},this.getX=function(){return this._x},this.getY=function(){return this._y},this.getLevel=function(){return this._level},this.getDamage=function(){return this._weapon.getDamage()},this.getHP=function(){return this._HP},this.getMaxHP=function(){return this._MaxHP},this.getXP=function(){return this._XP},this.getNextXP=function(){return this._NextXP},RogueJS.scheduler.add(this,!0),this.levelUp=function(a){this._level+=1,this._XP=a,this._NextXP=Math.round(20*Math.pow(this._level,2)),this._MaxHP+=Math.round(3*Math.pow(this._level,1.5)),this.restoreHP(.5*this._MaxHP),flashScreen()},this.gainXP=function(a){this._XP+=a,this._XP>=this._NextXP&&this.levelUp(this._XP-this._NextXP)},this.damageHP=function(a){this._HP-=a},this.isDead=function(){return this._HP<=0},this.restoreHP=function(a){this._HP+=a,this._HP>this._MaxHP&&(this._HP=this._MaxHP)},this.changeWeapon=function(a){this._weapon=a}};Player.prototype._draw=function(){RogueJS.display.draw(this._x,this._y,"@",Colors.WHITE,Colors.FOV_FLOOR)},Player.prototype.act=function(){this._HP<=0?RogueJS.postmortem():(RogueJS.engine.lock(),window.addEventListener("keydown",this))},Player.prototype.handleEvent=function(a){if(!(this._HP<=0)){var b={};b[38]=0,b[33]=1,b[39]=2,b[34]=3,b[40]=4,b[35]=5,b[37]=6,b[36]=7,b[190]=99,b[46]=99,b[71]=100,b[85]=100;var c=a.keyCode;if(c in b){var d,e;if(b[c]>=99)return d=this._x,e=this._y,window.removeEventListener("keydown",this),100==b[c]&&RogueJS.useItem(d,e,this),this.firePassives(),RogueJS.engine.unlock(),void recalculateMap();var f=ROT.DIRS[8][b[c]];if(d=this._x+f[0],e=this._y+f[1],1==RogueJSData[d+","+e])return void this.firePassives();if(IsOccupied(d,e))attackTile(this,d,e),window.removeEventListener("keydown",this),this.firePassives(),RogueJS.engine.unlock();else{var g=checkUnderFoot(d,e);g&&MessageLog("You are standing on a %c{"+Colors.ORANGE_GOLD+"}"+g.getName()+"%c{}."),RogueJS.display.draw(this._x,this._y,RogueJS.map[this._x+","+this._y]),this._x=d,this._y=e,this._draw(),window.removeEventListener("keydown",this),this.firePassives(),recalculateMap(),RogueJS.engine.unlock()}}}};var RogueJSData={},RogueJSLight={},Entities=[],Messages=[],MIN_MOBS=6,MAX_MOBS=13,MIN_ITEMS=5,MAX_ITEMS=10,CHANCE_RARE=5,CHANCE_UNCOMMON=15,CHANCE_COMMON=25,CHANCE_FREQUENT=35,RogueJS={w:93,h:28,display:null,hud:null,msgLog:null,map:null,player:null,engine:null,fov:null,lighting:null,scheduler:null,FOV_RADIUS:5,fovmap:[],discovered:[],level:1,init:function(){this.display=new ROT.Display({width:this.w,height:this.h,fontSize:16}),this.hud=new ROT.Display({width:this.w,height:1,fontSize:16}),this.msgLog=new ROT.Display({width:this.w,height:5,fontSize:16}),this.scheduler=new ROT.Scheduler.Simple,document.getElementById("RogueCanvas").appendChild(this.display.getContainer()),document.getElementById("RogueHUD").appendChild(this.hud.getContainer()),document.getElementById("RogueMessages").appendChild(this.msgLog.getContainer()),document.getElementById("RogueCanvas").addEventListener("click",canvasClick),this.fov=new ROT.FOV.PreciseShadowcasting(lightPasses),this.lighting=new ROT.Lighting(reflectivity,{range:this.FOV_RADIUS+1,passes:4}),this.lighting.setFOV(this.fov),this.makeLevel(this.level),MessageLog("Welcome to the %c{red}Rogue's Dungeon%c{}!"),this.lighting.setLight(RogueJS.player.getX(),RogueJS.player.getY(),[240,240,30]),this.lighting.compute(lightingCallback),this.engine=new ROT.Engine(this.scheduler),this.engine.start(),UpdateHUD()},createPlayer:function(){var a=RoomAndPosition();this.player?(this.player._x=a[0],this.player._y=a[1],Entities.push(this.player),RogueJS.scheduler.add(this.player,!0)):(this.player=new Player(a[0],a[1]),Entities.push(this.player))},createMonsters:function(a){for(var b=getRandom(MIN_MOBS,MAX_MOBS),c=0;c<b;)for(var d=0,e=monsters.length;d<e;d++){var f=monsters[d],g=!1,h=ROT.RNG.getPercentage();if(!g&&f.weighting.rare&&a>=f.weighting.rare[0]&&a<=f.weighting.rare[1]&&h<=CHANCE_RARE&&(g=!0),!g&&f.weighting.uncommon&&a>=f.weighting.uncommon[0]&&a<=f.weighting.uncommon[1]&&h<=CHANCE_UNCOMMON&&(g=!0),!g&&f.weighting.common&&a>=f.weighting.common[0]&&a<=f.weighting.common[1]&&h<=CHANCE_COMMON&&(g=!0),!g&&f.weighting.frequent&&a>=f.weighting.frequent[0]&&a<=f.weighting.frequent[1]&&h<=CHANCE_FREQUENT&&(g=!0),g){var i=RoomAndPosition();if(!IsOccupied(i[0],i[1])){var j=new Actor(i[0],i[1],f.char,f.color,f.name,f.maxHP,f.XP,f.range,f.weapon);Entities.push(j),c++}}}},createItems:function(a){for(var b=getRandom(MIN_ITEMS,MAX_ITEMS),c=0;c<b;)for(var d=0,e=items.length;d<e;d++){var f=items[d],g=!1,h=ROT.RNG.getPercentage();if(!g&&f.weighting.rare&&a>=f.weighting.rare[0]&&a<=f.weighting.rare[1]&&(console.log(f.name+" / rare / "+h),h<=CHANCE_RARE&&(g=!0)),!g&&f.weighting.uncommon&&a>=f.weighting.uncommon[0]&&a<=f.weighting.uncommon[1]&&(console.log(f.name+" / uncommon / "+h),h<=CHANCE_UNCOMMON&&(g=!0)),!g&&f.weighting.common&&a>=f.weighting.common[0]&&a<=f.weighting.common[1]&&(console.log(f.name+" / common / "+h),h<=CHANCE_COMMON&&(g=!0)),!g&&f.weighting.frequent&&a>=f.weighting.frequent[0]&&a<=f.weighting.frequent[1]&&(console.log(f.name+" / frequent / "+h),h<=CHANCE_FREQUENT&&(g=!0)),g){var i=RoomAndPosition();if(!IsOccupied(i[0],i[1])){var j=new Item(i[0],i[1],f.name,f.char,f.color,f.ability);Entities.push(j),c++}}}},placeStairs:function(){var a=RoomAndPosition();if(!IsOccupied(a[0],a[1])){var b=new Item(a[0],a[1],"Stairs",">",Colors.WHITE,RogueJS.nextLevel);return void Entities.push(b)}RogueJS.placeStairs()},nextLevel:function(){RogueJS.engine.lock(),Entities=[],RogueJS.scheduler.clear(),RogueJS.level=RogueJS.level+1,MessageLog("You advance to %c{red}Level "+RogueJS.level+"%c{}..."),RogueJS.makeLevel(RogueJS.level)},makeLevel:function(a){this.display.clear(),this.map=new ROT.Map.Uniform(this.w,this.h,{roomWidth:[5,10],roomHeight:[5,10],roomDugPercentage:.9,timeLimit:5e3}),this.map.create(function(a,b,c){RogueJSData[a+","+b]=c,RogueJS.discovered[a+","+b]=0}),this.createItems(a),this.placeStairs(),this.createMonsters(a),this.createPlayer(),recalculateMap(),this.engine&&this.engine.unlock()},useItem:function(a,b,c){var d=checkUnderFoot(a,b);if(d){var e=Entities.indexOf(d);RogueJS.scheduler.remove(d),Entities.splice(e,1),d.useAbility(c),MessageLog(c.getName()+" uses the %c{"+Colors.ORANGE_GOLD+"}"+d.getName()+"%c{}!")}else MessageLog("There's nothing here.")},postmortem:function(){RogueJS.engine.lock();for(var a=0;a<10;a++)clearTimeout(a);this.display.clear(),this.scheduler=null,this.RogueJSData=null,this.Entities=null;var b={name:this.player.getName(),maxHP:this.player.getMaxHP()};this.player=null,document.getElementById("RogueHUD").style.display="none",this.display.drawText(5,2,"You have %c{red}perished%c{} on level "+this.level),this.display.drawText(5,5,"You had a Max HP of "+b.maxHP+"."),this.display.drawText(5,25,"Refresh your browser to play again."),this.engine=null}},recalculateMap=function(){for(var a=0;a<RogueJS.h;a++)for(var b=0;b<RogueJS.w;b++)if(0==RogueJS.discovered[b+","+a])RogueJS.display.draw(b,a,"",Colors.BLACK,Colors.BLACK);else{var c=RogueJSData[b+","+a]?Colors.DISCOVERED_WALL:Colors.DISCOVERED_FLOOR;RogueJS.display.draw(b,a,"",Colors.WHITE,c)}RogueJS.lighting.clearLights(),RogueJS.lighting.setLight(RogueJS.player.getX(),RogueJS.player.getY(),[240,240,30]),RogueJS.lighting.compute(lightingCallback),RogueJS.fovmap=[],RogueJS.player&&RogueJS.fov.compute(RogueJS.player._x,RogueJS.player._y,RogueJS.FOV_RADIUS,function(a,b,c,d){var e=c?"":"@",f=RogueJSData[a+","+b]?Colors.FOV_WALL:Colors.FOV_FLOOR;RogueJS.display.draw(a,b,e,Colors.WHITE,f),RogueJS.fovmap[a+","+b]=1,RogueJS.discovered[a+","+b]=1;var g=[100,100,100],h=RogueJSData[a+","+b]?[100,100,100]:[50,50,50],i=g;[a+","+b]in RogueJSLight&&(i=ROT.Color.add(i,RogueJSLight[a+","+b]));var j=ROT.Color.multiply(h,i);RogueJS.display.draw(a,b,null,null,ROT.Color.toRGB(j))});for(var d=0;d<Entities.length;d++)Entities[d]._draw();UpdateHUD()},drawBar=function(a,b,c,d,e,f,g,h){for(var i=Math.ceil((c-h.length)/2),j=Math.floor(e/d*c),k="",l=0;l<j;l++)RogueJS.hud.draw(a+l,b,null,g,f),l>=i&&(k+="%c{white}%b{"+f+"}"+h.charAt(l-i));for(var l=j;l<c;l++)RogueJS.hud.draw(a+l,b,null,f,g),l>=i&&(k+="%c{white}%b{"+g+"}"+h.charAt(l-i));RogueJS.hud.drawText(i+a,b,k)},IsInFOV=function(a,b){return 1===RogueJS.fovmap[a+","+b]},IsOccupied=function(a,b){if(RogueJS.player&&RogueJS.player.getX()==a&&RogueJS.player.getY()==b)return!0;for(var c=0;c<Entities.length;c++)if(Entities[c]._x==a&&Entities[c]._y==b&&Entities[c]instanceof Actor)return!0;return!1},RoomAndPosition=function(){var a=getRandom(0,RogueJS.map.getRooms().length);return RogueJS.map.getRooms()[a].getRandomPosition()},lightingCallback=function(a,b,c){RogueJSLight[a+","+b]=c},ROT={isSupported:function(){return!(!document.createElement("canvas").getContext||!Function.prototype.bind)},DEFAULT_WIDTH:80,DEFAULT_HEIGHT:25,DIRS:{4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95};ROT.Text={RE_COLORS:/%([bc]){([^}]*)}/g,TYPE_TEXT:0,TYPE_NEWLINE:1,TYPE_FG:2,TYPE_BG:3,measure:function(a,b){for(var c={width:0,height:1},d=this.tokenize(a,b),e=0,f=0;f<d.length;f++){var g=d[f];switch(g.type){case this.TYPE_TEXT:e+=g.value.length;break;case this.TYPE_NEWLINE:c.height++,c.width=Math.max(c.width,e),e=0}}return c.width=Math.max(c.width,e),c},tokenize:function(a,b){var c=[],d=0;a.replace(this.RE_COLORS,function(b,e,f,g){var h=a.substring(d,g);return h.length&&c.push({type:ROT.Text.TYPE_TEXT,value:h}),c.push({type:"c"==e?ROT.Text.TYPE_FG:ROT.Text.TYPE_BG,value:f.trim()}),d=g+b.length,""});var e=a.substring(d);return e.length&&c.push({type:ROT.Text.TYPE_TEXT,value:e}),this._breakLines(c,b)},_breakLines:function(a,b){b||(b=1/0);for(var c=0,d=0,e=-1;c<a.length;){var f=a[c];if(f.type==ROT.Text.TYPE_NEWLINE&&(d=0,e=-1),f.type==ROT.Text.TYPE_TEXT){for(;0==d&&" "==f.value.charAt(0);)f.value=f.value.substring(1);var g=f.value.indexOf("\n");if(g!=-1){f.value=this._breakInsideToken(a,c,g,!0);for(var h=f.value.split("");h.length&&" "==h[h.length-1];)h.pop();f.value=h.join("")}if(f.value.length){if(d+f.value.length>b){for(var g=-1;;){var i=f.value.indexOf(" ",g+1);if(i==-1)break;if(d+i>b)break;g=i}if(g!=-1)f.value=this._breakInsideToken(a,c,g,!0);else if(e!=-1){var f=a[e],j=f.value.lastIndexOf(" ");f.value=this._breakInsideToken(a,e,j,!0),c=e}else f.value=this._breakInsideToken(a,c,b-d,!1)}else d+=f.value.length,f.value.indexOf(" ")!=-1&&(e=c);c++}else a.splice(c,1)}else c++}a.push({type:ROT.Text.TYPE_NEWLINE});for(var k=null,c=0;c<a.length;c++){var f=a[c];switch(f.type){case ROT.Text.TYPE_TEXT:k=f;break;case ROT.Text.TYPE_NEWLINE:if(k){for(var h=k.value.split("");h.length&&" "==h[h.length-1];)h.pop();k.value=h.join("")}k=null}}return a.pop(),a},_breakInsideToken:function(a,b,c,d){var e={type:ROT.Text.TYPE_NEWLINE},f={type:ROT.Text.TYPE_TEXT,value:a[b].value.substring(c+(d?1:0))};return a.splice(b+1,0,e,f),a[b].value.substring(0,c)}},Array.prototype.random=Array.prototype.random||function(){return this.length?this[Math.floor(ROT.RNG.getUniform()*this.length)]:null},Array.prototype.randomize=Array.prototype.randomize||function(){for(var a=[],b=this.slice();b.length;){var c=b.indexOf(b.random());a.push(b.splice(c,1)[0])}return a},Number.prototype.mod=Number.prototype.mod||function(a){return(this%a+a)%a},String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)},String.prototype.lpad=String.prototype.lpad||function(a,b){for(var c=a||"0",d=b||2,e="";e.length<d-this.length;)e+=c;return e=e.substring(0,d-this.length),e+this},String.prototype.rpad=String.prototype.rpad||function(a,b){for(var c=a||"0",d=b||2,e="";e.length<d-this.length;)e+=c;return e=e.substring(0,d-this.length),this+e},String.format=String.format||function(a){var b=String.format.map,c=Array.prototype.slice.call(arguments,1),d=function(d,e,f,g){if("%"==a.charAt(g-1))return d.substring(1);if(!c.length)return d;var h=c[0],i=e||f,j=i.split(","),k=j.shift(),l=b[k.toLowerCase()];if(!l)return d;var h=c.shift(),m=h[l].apply(h,j),n=k.charAt(0);return n!=n.toLowerCase()&&(m=m.capitalize()),m};return a.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,d)},String.format.map=String.format.map||{s:"toString"},String.prototype.format=String.prototype.format||function(){var a=Array.prototype.slice.call(arguments);return a.unshift(this),String.format.apply(String,a)},Object.create||(Object.create=function(a){var b=function(){};return b.prototype=a,new b}),Function.prototype.extend=Function.prototype.extend||function(a){return this.prototype=Object.create(a.prototype),this.prototype.constructor=this,this},"undefined"!=typeof window&&(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){return setTimeout(a,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(a){return clearTimeout(a)}),ROT.Display=function(a){var b=document.createElement("canvas");this._context=b.getContext("2d"),this._data={},this._dirty=!1,this._options={},this._backend=null;var c={width:ROT.DEFAULT_WIDTH,height:ROT.DEFAULT_HEIGHT,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1,termColor:"xterm"};for(var d in a)c[d]=a[d];this.setOptions(c),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),requestAnimationFrame(this._tick)},ROT.Display.prototype.DEBUG=function(a,b,c){var d=[this._options.bg,this._options.fg];this.draw(a,b,null,null,d[c%d.length])},ROT.Display.prototype.clear=function(){this._data={},this._dirty=!0},ROT.Display.prototype.setOptions=function(a){for(var b in a)this._options[b]=a[b];if(a.width||a.height||a.fontSize||a.fontFamily||a.spacing||a.layout){a.layout&&(this._backend=new(ROT.Display[a.layout.capitalize()])(this._context));var c=(this._options.fontStyle?this._options.fontStyle+" ":"")+this._options.fontSize+"px "+this._options.fontFamily;this._context.font=c,this._backend.compute(this._options),this._context.font=c,this._context.textAlign="center",this._context.textBaseline="middle",this._dirty=!0}return this},ROT.Display.prototype.getOptions=function(){return this._options},ROT.Display.prototype.getContainer=function(){return this._context.canvas},ROT.Display.prototype.computeSize=function(a,b){return this._backend.computeSize(a,b,this._options)},ROT.Display.prototype.computeFontSize=function(a,b){return this._backend.computeFontSize(a,b,this._options)},ROT.Display.prototype.eventToPosition=function(a){if(a.touches)var b=a.touches[0].clientX,c=a.touches[0].clientY;else var b=a.clientX,c=a.clientY;var d=this._context.canvas.getBoundingClientRect();return b-=d.left,c-=d.top,b*=this._context.canvas.width/this._context.canvas.clientWidth,c*=this._context.canvas.height/this._context.canvas.clientHeight,b<0||c<0||b>=this._context.canvas.width||c>=this._context.canvas.height?[-1,-1]:this._backend.eventToPosition(b,c)},ROT.Display.prototype.draw=function(a,b,c,d,e){d||(d=this._options.fg),e||(e=this._options.bg),this._data[a+","+b]=[a,b,c,d,e],this._dirty!==!0&&(this._dirty||(this._dirty={}),this._dirty[a+","+b]=!0)},ROT.Display.prototype.drawText=function(a,b,c,d){var e=null,f=null,g=a,h=b,i=1;d||(d=this._options.width-a);for(var j=ROT.Text.tokenize(c,d);j.length;){var k=j.shift();switch(k.type){case ROT.Text.TYPE_TEXT:for(var l=!1,m=!1,n=!1,o=!1,p=0;p<k.value.length;p++){var q=k.value.charCodeAt(p),r=k.value.charAt(p);n=q>255&&q<65377||q>65500&&q<65512&&q>65518,l=32==r.charCodeAt(0)||12288==r.charCodeAt(0),!o||n||l||g++,n&&!m&&g++,this.draw(g++,h,r,e,f),m=l,o=n}break;case ROT.Text.TYPE_FG:e=k.value||null;break;case ROT.Text.TYPE_BG:f=k.value||null;break;case ROT.Text.TYPE_NEWLINE:g=a,h++,i++}}return i},ROT.Display.prototype._tick=function(){if(requestAnimationFrame(this._tick),this._dirty){if(this._dirty===!0){this._context.fillStyle=this._options.bg,this._context.fillRect(0,0,this._context.canvas.width,this._context.canvas.height);for(var a in this._data)this._draw(a,!1)}else for(var b in this._dirty)this._draw(b,!0);this._dirty=!1}},ROT.Display.prototype._draw=function(a,b){var c=this._data[a];c[4]!=this._options.bg&&(b=!0),this._backend.draw(c,b);
},ROT.Display.Backend=function(a){this._context=a},ROT.Display.Backend.prototype.compute=function(a){},ROT.Display.Backend.prototype.draw=function(a,b){},ROT.Display.Backend.prototype.computeSize=function(a,b){},ROT.Display.Backend.prototype.computeFontSize=function(a,b){},ROT.Display.Backend.prototype.eventToPosition=function(a,b){},ROT.Display.Rect=function(a){ROT.Display.Backend.call(this,a),this._spacingX=0,this._spacingY=0,this._canvasCache={},this._options={}},ROT.Display.Rect.extend(ROT.Display.Backend),ROT.Display.Rect.cache=!1,ROT.Display.Rect.prototype.compute=function(a){this._canvasCache={},this._options=a;var b=Math.ceil(this._context.measureText("W").width);this._spacingX=Math.ceil(a.spacing*b),this._spacingY=Math.ceil(a.spacing*a.fontSize),this._options.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._context.canvas.width=a.width*this._spacingX,this._context.canvas.height=a.height*this._spacingY},ROT.Display.Rect.prototype.draw=function(a,b){this.constructor.cache?this._drawWithCache(a,b):this._drawNoCache(a,b)},ROT.Display.Rect.prototype._drawWithCache=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=""+e+f+g;if(h in this._canvasCache)var i=this._canvasCache[h];else{var j=this._options.border,i=document.createElement("canvas"),k=i.getContext("2d");if(i.width=this._spacingX,i.height=this._spacingY,k.fillStyle=g,k.fillRect(j,j,i.width-j,i.height-j),e){k.fillStyle=f,k.font=this._context.font,k.textAlign="center",k.textBaseline="middle";for(var l=[].concat(e),m=0;m<l.length;m++)k.fillText(l[m],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[h]=i}this._context.drawImage(i,c*this._spacingX,d*this._spacingY)},ROT.Display.Rect.prototype._drawNoCache=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4];if(b){var h=this._options.border;this._context.fillStyle=g,this._context.fillRect(c*this._spacingX+h,d*this._spacingY+h,this._spacingX-h,this._spacingY-h)}if(e){this._context.fillStyle=f;for(var i=[].concat(e),j=0;j<i.length;j++)this._context.fillText(i[j],(c+.5)*this._spacingX,Math.ceil((d+.5)*this._spacingY))}},ROT.Display.Rect.prototype.computeSize=function(a,b){var c=Math.floor(a/this._spacingX),d=Math.floor(b/this._spacingY);return[c,d]},ROT.Display.Rect.prototype.computeFontSize=function(a,b){var c=Math.floor(a/this._options.width),d=Math.floor(b/this._options.height),e=this._context.font;this._context.font="100px "+this._options.fontFamily;var f=Math.ceil(this._context.measureText("W").width);this._context.font=e;var g=f/100,h=g*d/c;return h>1&&(d=Math.floor(d/h)),Math.floor(d/this._options.spacing)},ROT.Display.Rect.prototype.eventToPosition=function(a,b){return[Math.floor(a/this._spacingX),Math.floor(b/this._spacingY)]},ROT.Display.Hex=function(a){ROT.Display.Backend.call(this,a),this._spacingX=0,this._spacingY=0,this._hexSize=0,this._options={}},ROT.Display.Hex.extend(ROT.Display.Backend),ROT.Display.Hex.prototype.compute=function(a){this._options=a;var b=Math.ceil(this._context.measureText("W").width);if(this._hexSize=Math.floor(a.spacing*(a.fontSize+b/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,a.transpose)var c="height",d="width";else var c="width",d="height";this._context.canvas[c]=Math.ceil((a.width+1)*this._spacingX),this._context.canvas[d]=Math.ceil((a.height-1)*this._spacingY+2*this._hexSize)},ROT.Display.Hex.prototype.draw=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=[(c+1)*this._spacingX,d*this._spacingY+this._hexSize];if(this._options.transpose&&h.reverse(),b&&(this._context.fillStyle=g,this._fill(h[0],h[1])),e){this._context.fillStyle=f;for(var i=[].concat(e),j=0;j<i.length;j++)this._context.fillText(i[j],h[0],Math.ceil(h[1]))}},ROT.Display.Hex.prototype.computeSize=function(a,b){this._options.transpose&&(a+=b,b=a-b,a-=b);var c=Math.floor(a/this._spacingX)-1,d=Math.floor((b-2*this._hexSize)/this._spacingY+1);return[c,d]},ROT.Display.Hex.prototype.computeFontSize=function(a,b){this._options.transpose&&(a+=b,b=a-b,a-=b);var c=2*a/((this._options.width+1)*Math.sqrt(3))-1,d=b/(2+1.5*(this._options.height-1)),e=Math.min(c,d),f=this._context.font;this._context.font="100px "+this._options.fontFamily;var g=Math.ceil(this._context.measureText("W").width);this._context.font=f;var h=g/100;e=Math.floor(e)+1;var i=2*e/(this._options.spacing*(1+h/Math.sqrt(3)));return Math.ceil(i)-1},ROT.Display.Hex.prototype.eventToPosition=function(a,b){if(this._options.transpose){a+=b,b=a-b,a-=b;var c=this._context.canvas.width}else var c=this._context.canvas.height;var d=c/this._options.height;return b=Math.floor(b/d),b.mod(2)?(a-=this._spacingX,a=1+2*Math.floor(a/(2*this._spacingX))):a=2*Math.floor(a/(2*this._spacingX)),[a,b]},ROT.Display.Hex.prototype._fill=function(a,b){var c=this._hexSize,d=this._options.border;this._context.beginPath(),this._options.transpose?(this._context.moveTo(a-c+d,b),this._context.lineTo(a-c/2+d,b+this._spacingX-d),this._context.lineTo(a+c/2-d,b+this._spacingX-d),this._context.lineTo(a+c-d,b),this._context.lineTo(a+c/2-d,b-this._spacingX+d),this._context.lineTo(a-c/2+d,b-this._spacingX+d),this._context.lineTo(a-c+d,b)):(this._context.moveTo(a,b-c+d),this._context.lineTo(a+this._spacingX-d,b-c/2+d),this._context.lineTo(a+this._spacingX-d,b+c/2-d),this._context.lineTo(a,b+c-d),this._context.lineTo(a-this._spacingX+d,b+c/2-d),this._context.lineTo(a-this._spacingX+d,b-c/2+d),this._context.lineTo(a,b-c+d)),this._context.fill()},ROT.Display.Tile=function(a){ROT.Display.Rect.call(this,a),this._options={},this._colorCanvas=document.createElement("canvas")},ROT.Display.Tile.extend(ROT.Display.Rect),ROT.Display.Tile.prototype.compute=function(a){this._options=a,this._context.canvas.width=a.width*a.tileWidth,this._context.canvas.height=a.height*a.tileHeight,this._colorCanvas.width=a.tileWidth,this._colorCanvas.height=a.tileHeight},ROT.Display.Tile.prototype.draw=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=this._options.tileWidth,i=this._options.tileHeight;if(b&&(this._options.tileColorize?this._context.clearRect(c*h,d*i,h,i):(this._context.fillStyle=g,this._context.fillRect(c*h,d*i,h,i))),e)for(var j=[].concat(e),k=0;k<j.length;k++){var l=this._options.tileMap[j[k]];if(!l)throw new Error("Char '"+j[k]+"' not found in tileMap");if(this._options.tileColorize){var m=this._colorCanvas,n=m.getContext("2d");n.clearRect(0,0,h,i),n.drawImage(this._options.tileSet,l[0],l[1],h,i,0,0,h,i),"transparent"!=f&&(n.fillStyle=f,n.globalCompositeOperation="source-atop",n.fillRect(0,0,h,i)),"transparent"!=g&&(n.fillStyle=g,n.globalCompositeOperation="destination-over",n.fillRect(0,0,h,i)),this._context.drawImage(m,c*h,d*i,h,i)}else this._context.drawImage(this._options.tileSet,l[0],l[1],h,i,c*h,d*i,h,i)}},ROT.Display.Tile.prototype.computeSize=function(a,b){var c=Math.floor(a/this._options.tileWidth),d=Math.floor(b/this._options.tileHeight);return[c,d]},ROT.Display.Tile.prototype.computeFontSize=function(a,b){var c=Math.floor(a/this._options.width),d=Math.floor(b/this._options.height);return[c,d]},ROT.Display.Tile.prototype.eventToPosition=function(a,b){return[Math.floor(a/this._options.tileWidth),Math.floor(b/this._options.tileHeight)]},ROT.RNG={getSeed:function(){return this._seed},setSeed:function(a){return a=a<1?1/a:a,this._seed=a,this._s0=(a>>>0)*this._frac,a=69069*a+1>>>0,this._s1=a*this._frac,a=69069*a+1>>>0,this._s2=a*this._frac,this._c=1,this},getUniform:function(){var a=2091639*this._s0+this._c*this._frac;return this._s0=this._s1,this._s1=this._s2,this._c=0|a,this._s2=a-this._c,this._s2},getUniformInt:function(a,b){var c=Math.max(a,b),d=Math.min(a,b);return Math.floor(this.getUniform()*(c-d+1))+d},getNormal:function(a,b){do var c=2*this.getUniform()-1,d=2*this.getUniform()-1,e=c*c+d*d;while(e>1||0==e);var f=c*Math.sqrt(-2*Math.log(e)/e);return(a||0)+f*(b||1)},getPercentage:function(){return 1+Math.floor(100*this.getUniform())},getWeightedValue:function(a){var b=0;for(var c in a)b+=a[c];var d=this.getUniform()*b,e=0;for(var c in a)if(e+=a[c],d<e)return c;return c},getState:function(){return[this._s0,this._s1,this._s2,this._c]},setState:function(a){return this._s0=a[0],this._s1=a[1],this._s2=a[2],this._c=a[3],this},clone:function(){var a=Object.create(this);return a.setState(this.getState()),a},_s0:0,_s1:0,_s2:0,_c:0,_frac:2.3283064365386963e-10},ROT.RNG.setSeed(Date.now()),ROT.StringGenerator=function(a){this._options={words:!1,order:3,prior:.001};for(var b in a)this._options[b]=a[b];this._boundary=String.fromCharCode(0),this._suffix=this._boundary,this._prefix=[];for(var c=0;c<this._options.order;c++)this._prefix.push(this._boundary);this._priorValues={},this._priorValues[this._boundary]=this._options.prior,this._data={}},ROT.StringGenerator.prototype.clear=function(){this._data={},this._priorValues={}},ROT.StringGenerator.prototype.generate=function(){for(var a=[this._sample(this._prefix)];a[a.length-1]!=this._boundary;)a.push(this._sample(a));return this._join(a.slice(0,-1))},ROT.StringGenerator.prototype.observe=function(a){for(var b=this._split(a),c=0;c<b.length;c++)this._priorValues[b[c]]=this._options.prior;b=this._prefix.concat(b).concat(this._suffix);for(var c=this._options.order;c<b.length;c++)for(var d=b.slice(c-this._options.order,c),e=b[c],f=0;f<d.length;f++){var g=d.slice(f);this._observeEvent(g,e)}},ROT.StringGenerator.prototype.getStats=function(){var a=[],b=0;for(var c in this._priorValues)b++;b--,a.push("distinct samples: "+b);var d=0,e=0;for(var c in this._data){d++;for(var f in this._data[c])e++}return a.push("dictionary size (contexts): "+d),a.push("dictionary size (events): "+e),a.join(", ")},ROT.StringGenerator.prototype._split=function(a){return a.split(this._options.words?/\s+/:"")},ROT.StringGenerator.prototype._join=function(a){return a.join(this._options.words?" ":"")},ROT.StringGenerator.prototype._observeEvent=function(a,b){var c=this._join(a);c in this._data||(this._data[c]={});var d=this._data[c];b in d||(d[b]=0),d[b]++},ROT.StringGenerator.prototype._sample=function(a){a=this._backoff(a);var b=this._join(a),c=this._data[b],d={};if(this._options.prior){for(var e in this._priorValues)d[e]=this._priorValues[e];for(var e in c)d[e]+=c[e]}else d=c;return ROT.RNG.getWeightedValue(d)},ROT.StringGenerator.prototype._backoff=function(a){for(a.length>this._options.order?a=a.slice(-this._options.order):a.length<this._options.order&&(a=this._prefix.slice(0,this._options.order-a.length).concat(a));!(this._join(a)in this._data)&&a.length>0;)a=a.slice(1);return a},ROT.EventQueue=function(){this._time=0,this._events=[],this._eventTimes=[]},ROT.EventQueue.prototype.getTime=function(){return this._time},ROT.EventQueue.prototype.clear=function(){return this._events=[],this._eventTimes=[],this},ROT.EventQueue.prototype.add=function(a,b){for(var c=this._events.length,d=0;d<this._eventTimes.length;d++)if(this._eventTimes[d]>b){c=d;break}this._events.splice(c,0,a),this._eventTimes.splice(c,0,b)},ROT.EventQueue.prototype.get=function(){if(!this._events.length)return null;var a=this._eventTimes.splice(0,1)[0];if(a>0){this._time+=a;for(var b=0;b<this._eventTimes.length;b++)this._eventTimes[b]-=a}return this._events.splice(0,1)[0]},ROT.EventQueue.prototype.remove=function(a){var b=this._events.indexOf(a);return b!=-1&&(this._remove(b),!0)},ROT.EventQueue.prototype._remove=function(a){this._events.splice(a,1),this._eventTimes.splice(a,1)},ROT.Scheduler=function(){this._queue=new ROT.EventQueue,this._repeat=[],this._current=null},ROT.Scheduler.prototype.getTime=function(){return this._queue.getTime()},ROT.Scheduler.prototype.add=function(a,b){return b&&this._repeat.push(a),this},ROT.Scheduler.prototype.clear=function(){return this._queue.clear(),this._repeat=[],this._current=null,this},ROT.Scheduler.prototype.remove=function(a){var b=this._queue.remove(a),c=this._repeat.indexOf(a);return c!=-1&&this._repeat.splice(c,1),this._current==a&&(this._current=null),b},ROT.Scheduler.prototype.next=function(){return this._current=this._queue.get(),this._current},ROT.Scheduler.Simple=function(){ROT.Scheduler.call(this)},ROT.Scheduler.Simple.extend(ROT.Scheduler),ROT.Scheduler.Simple.prototype.add=function(a,b){return this._queue.add(a,0),ROT.Scheduler.prototype.add.call(this,a,b)},ROT.Scheduler.Simple.prototype.next=function(){return this._current&&this._repeat.indexOf(this._current)!=-1&&this._queue.add(this._current,0),ROT.Scheduler.prototype.next.call(this)},ROT.Scheduler.Speed=function(){ROT.Scheduler.call(this)},ROT.Scheduler.Speed.extend(ROT.Scheduler),ROT.Scheduler.Speed.prototype.add=function(a,b){return this._queue.add(a,1/a.getSpeed()),ROT.Scheduler.prototype.add.call(this,a,b)},ROT.Scheduler.Speed.prototype.next=function(){return this._current&&this._repeat.indexOf(this._current)!=-1&&this._queue.add(this._current,1/this._current.getSpeed()),ROT.Scheduler.prototype.next.call(this)},ROT.Scheduler.Action=function(){ROT.Scheduler.call(this),this._defaultDuration=1,this._duration=this._defaultDuration},ROT.Scheduler.Action.extend(ROT.Scheduler),ROT.Scheduler.Action.prototype.add=function(a,b,c){return this._queue.add(a,c||this._defaultDuration),ROT.Scheduler.prototype.add.call(this,a,b)},ROT.Scheduler.Action.prototype.clear=function(){return this._duration=this._defaultDuration,ROT.Scheduler.prototype.clear.call(this)},ROT.Scheduler.Action.prototype.remove=function(a){return a==this._current&&(this._duration=this._defaultDuration),ROT.Scheduler.prototype.remove.call(this,a)},ROT.Scheduler.Action.prototype.next=function(){return this._current&&this._repeat.indexOf(this._current)!=-1&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),ROT.Scheduler.prototype.next.call(this)},ROT.Scheduler.Action.prototype.setDuration=function(a){return this._current&&(this._duration=a),this},ROT.Engine=function(a){this._scheduler=a,this._lock=1},ROT.Engine.prototype.start=function(){return this.unlock()},ROT.Engine.prototype.lock=function(){return this._lock++,this},ROT.Engine.prototype.unlock=function(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){var a=this._scheduler.next();if(!a)return this.lock();var b=a.act();b&&b.then&&(this.lock(),b.then(this.unlock.bind(this)))}return this},ROT.Map=function(a,b){this._width=a||ROT.DEFAULT_WIDTH,this._height=b||ROT.DEFAULT_HEIGHT},ROT.Map.prototype.create=function(a){},ROT.Map.prototype._fillMap=function(a){for(var b=[],c=0;c<this._width;c++){b.push([]);for(var d=0;d<this._height;d++)b[c].push(a)}return b},ROT.Map.Arena=function(a,b){ROT.Map.call(this,a,b)},ROT.Map.Arena.extend(ROT.Map),ROT.Map.Arena.prototype.create=function(a){for(var b=this._width-1,c=this._height-1,d=0;d<=b;d++)for(var e=0;e<=c;e++){var f=d&&e&&d<b&&e<c;a(d,e,f?0:1)}return this},ROT.Map.DividedMaze=function(a,b){ROT.Map.call(this,a,b),this._stack=[]},ROT.Map.DividedMaze.extend(ROT.Map),ROT.Map.DividedMaze.prototype.create=function(a){var b=this._width,c=this._height;this._map=[];for(var d=0;d<b;d++){this._map.push([]);for(var e=0;e<c;e++){var f=0==d||0==e||d+1==b||e+1==c;this._map[d].push(f?1:0)}}this._stack=[[1,1,b-2,c-2]],this._process();for(var d=0;d<b;d++)for(var e=0;e<c;e++)a(d,e,this._map[d][e]);return this._map=null,this},ROT.Map.DividedMaze.prototype._process=function(){for(;this._stack.length;){var a=this._stack.shift();this._partitionRoom(a)}},ROT.Map.DividedMaze.prototype._partitionRoom=function(a){for(var b=[],c=[],d=a[0]+1;d<a[2];d++){var e=this._map[d][a[1]-1],f=this._map[d][a[3]+1];!e||!f||d%2||b.push(d)}for(var g=a[1]+1;g<a[3];g++){var h=this._map[a[0]-1][g],i=this._map[a[2]+1][g];!h||!i||g%2||c.push(g)}if(b.length&&c.length){var j=b.random(),k=c.random();this._map[j][k]=1;var l=[],m=[];l.push(m);for(var d=a[0];d<j;d++)this._map[d][k]=1,m.push([d,k]);var m=[];l.push(m);for(var d=j+1;d<=a[2];d++)this._map[d][k]=1,m.push([d,k]);var m=[];l.push(m);for(var g=a[1];g<k;g++)this._map[j][g]=1,m.push([j,g]);var m=[];l.push(m);for(var g=k+1;g<=a[3];g++)this._map[j][g]=1,m.push([j,g]);for(var n=l.random(),d=0;d<l.length;d++){var m=l[d];if(m!=n){var o=m.random();this._map[o[0]][o[1]]=0}}this._stack.push([a[0],a[1],j-1,k-1]),this._stack.push([j+1,a[1],a[2],k-1]),this._stack.push([a[0],k+1,j-1,a[3]]),this._stack.push([j+1,k+1,a[2],a[3]])}},ROT.Map.IceyMaze=function(a,b,c){ROT.Map.call(this,a,b),this._regularity=c||0},ROT.Map.IceyMaze.extend(ROT.Map),ROT.Map.IceyMaze.prototype.create=function(a){var b=this._width,c=this._height,d=this._fillMap(1);b-=b%2?1:2,c-=c%2?1:2;var e=0,f=0,g=0,h=0,i=0,j=!1,k=[[0,0],[0,0],[0,0],[0,0]];do if(e=1+2*Math.floor(ROT.RNG.getUniform()*(b-1)/2),f=1+2*Math.floor(ROT.RNG.getUniform()*(c-1)/2),i||(d[e][f]=0),!d[e][f]){this._randomize(k);do{0==Math.floor(ROT.RNG.getUniform()*(this._regularity+1))&&this._randomize(k),j=!0;for(var l=0;l<4;l++)if(g=e+2*k[l][0],h=f+2*k[l][1],this._isFree(d,g,h,b,c)){d[g][h]=0,d[e+k[l][0]][f+k[l][1]]=0,e=g,f=h,j=!1,i++;break}}while(!j)}while(i+1<b*c/4);for(var l=0;l<this._width;l++)for(var m=0;m<this._height;m++)a(l,m,d[l][m]);return this._map=null,this},ROT.Map.IceyMaze.prototype._randomize=function(a){for(var b=0;b<4;b++)a[b][0]=0,a[b][1]=0;switch(Math.floor(4*ROT.RNG.getUniform())){case 0:a[0][0]=-1,a[1][0]=1,a[2][1]=-1,a[3][1]=1;break;case 1:a[3][0]=-1,a[2][0]=1,a[1][1]=-1,a[0][1]=1;break;case 2:a[2][0]=-1,a[3][0]=1,a[0][1]=-1,a[1][1]=1;break;case 3:a[1][0]=-1,a[0][0]=1,a[3][1]=-1,a[2][1]=1}},ROT.Map.IceyMaze.prototype._isFree=function(a,b,c,d,e){return!(b<1||c<1||b>=d||c>=e)&&a[b][c]},ROT.Map.EllerMaze=function(a,b){ROT.Map.call(this,a,b)},ROT.Map.EllerMaze.extend(ROT.Map),ROT.Map.EllerMaze.prototype.create=function(a){for(var b=this._fillMap(1),c=Math.ceil((this._width-2)/2),d=.375,e=[],f=[],g=0;g<c;g++)e.push(g),f.push(g);e.push(c-1);for(var h=1;h+3<this._height;h+=2)for(var g=0;g<c;g++){var i=2*g+1,j=h;b[i][j]=0,g!=e[g+1]&&ROT.RNG.getUniform()>d&&(this._addToList(g,e,f),b[i+1][j]=0),g!=e[g]&&ROT.RNG.getUniform()>d?this._removeFromList(g,e,f):b[i][j+1]=0}for(var g=0;g<c;g++){var i=2*g+1,j=h;b[i][j]=0,g!=e[g+1]&&(g==e[g]||ROT.RNG.getUniform()>d)&&(this._addToList(g,e,f),b[i+1][j]=0),this._removeFromList(g,e,f)}for(var g=0;g<this._width;g++)for(var h=0;h<this._height;h++)a(g,h,b[g][h]);return this},ROT.Map.EllerMaze.prototype._removeFromList=function(a,b,c){c[b[a]]=c[a],b[c[a]]=b[a],c[a]=a,b[a]=a},ROT.Map.EllerMaze.prototype._addToList=function(a,b,c){c[b[a+1]]=c[a],b[c[a]]=b[a+1],c[a]=a+1,b[a+1]=a},ROT.Map.Cellular=function(a,b,c){ROT.Map.call(this,a,b),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8},this.setOptions(c),this._dirs=ROT.DIRS[this._options.topology],this._map=this._fillMap(0)},ROT.Map.Cellular.extend(ROT.Map),ROT.Map.Cellular.prototype.randomize=function(a){for(var b=0;b<this._width;b++)for(var c=0;c<this._height;c++)this._map[b][c]=ROT.RNG.getUniform()<a?1:0;return this},ROT.Map.Cellular.prototype.setOptions=function(a){for(var b in a)this._options[b]=a[b]},ROT.Map.Cellular.prototype.set=function(a,b,c){this._map[a][b]=c},ROT.Map.Cellular.prototype.create=function(a){for(var b=this._fillMap(0),c=this._options.born,d=this._options.survive,e=0;e<this._height;e++){var f=1,g=0;6==this._options.topology&&(f=2,g=e%2);for(var h=g;h<this._width;h+=f){var i=this._map[h][e],j=this._getNeighbors(h,e);i&&d.indexOf(j)!=-1?b[h][e]=1:i||c.indexOf(j)==-1||(b[h][e]=1)}}this._map=b,this.serviceCallback(a)},ROT.Map.Cellular.prototype.serviceCallback=function(a){if(a)for(var b=0;b<this._height;b++){var c=1,d=0;6==this._options.topology&&(c=2,d=b%2);for(var e=d;e<this._width;e+=c)a(e,b,this._map[e][b])}},ROT.Map.Cellular.prototype._getNeighbors=function(a,b){for(var c=0,d=0;d<this._dirs.length;d++){var e=this._dirs[d],f=a+e[0],g=b+e[1];f<0||f>=this._width||g<0||g>=this._width||(c+=1==this._map[f][g]?1:0)}return c},ROT.Map.Cellular.prototype.connect=function(a,b,c){b||(b=0);for(var d=[],e={},f=0;f<this._width;f++)for(var g=0;g<this._height;g++)if(this._freeSpace(f,g,b)){var h=[f,g];e[this._pointKey(h)]=h,d.push([f,g])}var i=d[ROT.RNG.getUniformInt(0,d.length-1)],j=this._pointKey(i),k={};for(k[j]=i,delete e[j],this._findConnected(k,e,[i],!1,b);Object.keys(e).length>0;){var h=this._getFromTo(k,e),l=h[0],m=h[1],n={};n[this._pointKey(l)]=l,this._findConnected(n,e,[l],!0,b),this._tunnelToConnected(m,l,k,e,b,c);for(var o in n){var p=n[o];this._map[p[0]][p[1]]=b,k[o]=p,delete e[o]}}this.serviceCallback(a)},ROT.Map.Cellular.prototype._getFromTo=function(a,b){for(var c,d,e,f=Object.keys(a),g=Object.keys(b),h=0;h<5;h++){if(f.length<g.length){var i=f;d=a[i[ROT.RNG.getUniformInt(0,i.length-1)]],c=this._getClosest(d,b)}else{var i=g;c=b[i[ROT.RNG.getUniformInt(0,i.length-1)]],d=this._getClosest(c,a)}if(e=(c[0]-d[0])*(c[0]-d[0])+(c[1]-d[1])*(c[1]-d[1]),e<64)break}return[c,d]},ROT.Map.Cellular.prototype._getClosest=function(a,b){var c=null,d=null;for(k in b){var e=b[k],f=(e[0]-a[0])*(e[0]-a[0])+(e[1]-a[1])*(e[1]-a[1]);(null==d||f<d)&&(d=f,c=e)}return c},ROT.Map.Cellular.prototype._findConnected=function(a,b,c,d,e){for(;c.length>0;)for(var f=c.splice(0,1)[0],g=[[f[0]+1,f[1]],[f[0]-1,f[1]],[f[0],f[1]+1],[f[0],f[1]-1]],h=0;h<g.length;h++){var i=this._pointKey(g[h]);null==a[i]&&this._freeSpace(g[h][0],g[h][1],e)&&(a[i]=g[h],d||delete b[i],c.push(g[h]))}},ROT.Map.Cellular.prototype._tunnelToConnected=function(a,b,c,d,e,f){var g,h;this._pointKey(b);b[0]<a[0]?(g=b,h=a):(g=a,h=b);for(var i=g[0];i<=h[0];i++){this._map[i][g[1]]=e;var j=[i,g[1]],k=this._pointKey(j);c[k]=j,delete d[k]}f&&g[0]<h[0]&&f(g,[h[0],g[1]]);var l=h[0];b[1]<a[1]?(g=b,h=a):(g=a,h=b);for(var m=g[1];m<h[1];m++){this._map[l][m]=e;var j=[l,m],k=this._pointKey(j);c[k]=j,delete d[k]}f&&g[1]<h[1]&&f([h[0],g[1]],[h[0],h[1]])},ROT.Map.Cellular.prototype._freeSpace=function(a,b,c){return a>=0&&a<this._width&&b>=0&&b<this._height&&this._map[a][b]==c},ROT.Map.Cellular.prototype._pointKey=function(a){return a[0]+"."+a[1]},ROT.Map.Dungeon=function(a,b){ROT.Map.call(this,a,b),this._rooms=[],this._corridors=[]},ROT.Map.Dungeon.extend(ROT.Map),ROT.Map.Dungeon.prototype.getRooms=function(){return this._rooms},ROT.Map.Dungeon.prototype.getCorridors=function(){return this._corridors},ROT.Map.Digger=function(a,b,c){ROT.Map.Dungeon.call(this,a,b),this._options={roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3};for(var d in c)this._options[d]=c[d];this._features={Room:4,Corridor:4},this._featureAttempts=20,this._walls={},this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)},ROT.Map.Digger.extend(ROT.Map.Dungeon),ROT.Map.Digger.prototype.create=function(a){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;var b=(this._width-2)*(this._height-2);this._firstRoom();var c=Date.now();do{var d=Date.now();if(d-c>this._options.timeLimit)break;var e=this._findWall();if(!e)break;var f=e.split(","),g=parseInt(f[0]),h=parseInt(f[1]),i=this._getDiggingDirection(g,h);if(i){var j=0;do if(j++,this._tryFeature(g,h,i[0],i[1])){this._removeSurroundingWalls(g,h),this._removeSurroundingWalls(g-i[0],h-i[1]);break}while(j<this._featureAttempts);var k=0;for(var l in this._walls)this._walls[l]>1&&k++}}while(this._dug/b<this._options.dugPercentage||k);if(this._addDoors(),a)for(var m=0;m<this._width;m++)for(var n=0;n<this._height;n++)a(m,n,this._map[m][n]);return this._walls={},this._map=null,this},ROT.Map.Digger.prototype._digCallback=function(a,b,c){0==c||2==c?(this._map[a][b]=0,this._dug++):this._walls[a+","+b]=1},ROT.Map.Digger.prototype._isWallCallback=function(a,b){return!(a<0||b<0||a>=this._width||b>=this._height)&&1==this._map[a][b]},ROT.Map.Digger.prototype._canBeDugCallback=function(a,b){return!(a<1||b<1||a+1>=this._width||b+1>=this._height)&&1==this._map[a][b]},ROT.Map.Digger.prototype._priorityWallCallback=function(a,b){this._walls[a+","+b]=2},ROT.Map.Digger.prototype._firstRoom=function(){var a=Math.floor(this._width/2),b=Math.floor(this._height/2),c=ROT.Map.Feature.Room.createRandomCenter(a,b,this._options);this._rooms.push(c),c.create(this._digCallback)},ROT.Map.Digger.prototype._findWall=function(){var a=[],b=[];for(var c in this._walls){var d=this._walls[c];2==d?b.push(c):a.push(c)}var e=b.length?b:a;if(!e.length)return null;var c=e.random();return delete this._walls[c],c},ROT.Map.Digger.prototype._tryFeature=function(a,b,c,d){var e=ROT.RNG.getWeightedValue(this._features);return e=ROT.Map.Feature[e].createRandomAt(a,b,c,d,this._options),!!e.isValid(this._isWallCallback,this._canBeDugCallback)&&(e.create(this._digCallback),e instanceof ROT.Map.Feature.Room&&this._rooms.push(e),e instanceof ROT.Map.Feature.Corridor&&(e.createPriorityWalls(this._priorityWallCallback),this._corridors.push(e)),!0)},ROT.Map.Digger.prototype._removeSurroundingWalls=function(a,b){for(var c=ROT.DIRS[4],d=0;d<c.length;d++){var e=c[d],f=a+e[0],g=b+e[1];delete this._walls[f+","+g];var f=a+2*e[0],g=b+2*e[1];delete this._walls[f+","+g]}},ROT.Map.Digger.prototype._getDiggingDirection=function(a,b){if(a<=0||b<=0||a>=this._width-1||b>=this._height-1)return null;for(var c=null,d=ROT.DIRS[4],e=0;e<d.length;e++){var f=d[e],g=a+f[0],h=b+f[1];if(!this._map[g][h]){if(c)return null;c=f}}return c?[-c[0],-c[1]]:null},ROT.Map.Digger.prototype._addDoors=function(){for(var a=this._map,b=function(b,c){return 1==a[b][c]},c=0;c<this._rooms.length;c++){var d=this._rooms[c];d.clearDoors(),d.addDoors(b)}},ROT.Map.Uniform=function(a,b,c){ROT.Map.Dungeon.call(this,a,b),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3};for(var d in c)this._options[d]=c[d];this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)},ROT.Map.Uniform.extend(ROT.Map.Dungeon),ROT.Map.Uniform.prototype.create=function(a){for(var b=Date.now();;){var c=Date.now();if(c-b>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),!(this._rooms.length<2)&&this._generateCorridors())break}if(a)for(var d=0;d<this._width;d++)for(var e=0;e<this._height;e++)a(d,e,this._map[d][e]);return this},ROT.Map.Uniform.prototype._generateRooms=function(){var a=this._width-2,b=this._height-2;do{var c=this._generateRoom();if(this._dug/(a*b)>this._options.roomDugPercentage)break}while(c)},ROT.Map.Uniform.prototype._generateRoom=function(){for(var a=0;a<this._roomAttempts;){a++;var b=ROT.Map.Feature.Room.createRandom(this._width,this._height,this._options);if(b.isValid(this._isWallCallback,this._canBeDugCallback))return b.create(this._digCallback),this._rooms.push(b),b}return null},ROT.Map.Uniform.prototype._generateCorridors=function(){for(var a=0;a<this._corridorAttempts;){a++,this._corridors=[],this._map=this._fillMap(1);for(var b=0;b<this._rooms.length;b++){var c=this._rooms[b];c.clearDoors(),c.create(this._digCallback)}for(this._unconnected=this._rooms.slice().randomize(),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){var d=this._connected.random(),e=this._closestRoom(this._unconnected,d),f=this._closestRoom(this._connected,e),g=this._connectRooms(e,f);if(!g)break;if(!this._unconnected.length)return!0}}return!1},ROT.Map.Uniform.prototype._closestRoom=function(a,b){for(var c=1/0,d=b.getCenter(),e=null,f=0;f<a.length;f++){var g=a[f],h=g.getCenter(),i=h[0]-d[0],j=h[1]-d[1],k=i*i+j*j;k<c&&(c=k,e=g)}return e},ROT.Map.Uniform.prototype._connectRooms=function(a,b){var c=a.getCenter(),d=b.getCenter(),e=d[0]-c[0],f=d[1]-c[1];if(Math.abs(e)<Math.abs(f))var g=f>0?2:0,h=(g+2)%4,i=b.getLeft(),j=b.getRight(),k=0;else var g=e>0?1:3,h=(g+2)%4,i=b.getTop(),j=b.getBottom(),k=1;var l=this._placeInWall(a,g);if(!l)return!1;if(l[k]>=i&&l[k]<=j){var m=l.slice(),n=null;switch(h){case 0:n=b.getTop()-1;break;case 1:n=b.getRight()+1;break;case 2:n=b.getBottom()+1;break;case 3:n=b.getLeft()-1}m[(k+1)%2]=n,this._digLine([l,m])}else if(l[k]<i-1||l[k]>j+1){var o=l[k]-d[k];switch(h){case 0:case 1:var p=o<0?3:1;break;case 2:case 3:var p=o<0?1:3}h=(h+p)%4;var m=this._placeInWall(b,h);if(!m)return!1;var q=[0,0];q[k]=l[k];var r=(k+1)%2;q[r]=m[r],this._digLine([l,q,m])}else{var r=(k+1)%2,m=this._placeInWall(b,h);if(!m)return!1;var q=Math.round((m[r]+l[r])/2),s=[0,0],t=[0,0];s[k]=l[k],s[r]=q,t[k]=m[k],t[r]=q,this._digLine([l,s,t,m])}a.addDoor(l[0],l[1]),b.addDoor(m[0],m[1]);var k=this._unconnected.indexOf(a);k!=-1&&(this._unconnected.splice(k,1),this._connected.push(a));var k=this._unconnected.indexOf(b);return k!=-1&&(this._unconnected.splice(k,1),this._connected.push(b)),!0},ROT.Map.Uniform.prototype._placeInWall=function(a,b){var c=[0,0],d=[0,0],e=0;switch(b){case 0:d=[1,0],c=[a.getLeft(),a.getTop()-1],e=a.getRight()-a.getLeft()+1;break;case 1:d=[0,1],c=[a.getRight()+1,a.getTop()],e=a.getBottom()-a.getTop()+1;break;case 2:d=[1,0],c=[a.getLeft(),a.getBottom()+1],e=a.getRight()-a.getLeft()+1;break;case 3:d=[0,1],c=[a.getLeft()-1,a.getTop()],e=a.getBottom()-a.getTop()+1}for(var f=[],g=-2,h=0;h<e;h++){var i=c[0]+h*d[0],j=c[1]+h*d[1];f.push(null);var k=1==this._map[i][j];k?g!=h-1&&(f[h]=[i,j]):(g=h,h&&(f[h-1]=null))}for(var h=f.length-1;h>=0;h--)f[h]||f.splice(h,1);return f.length?f.random():null},ROT.Map.Uniform.prototype._digLine=function(a){for(var b=1;b<a.length;b++){var c=a[b-1],d=a[b],e=new ROT.Map.Feature.Corridor(c[0],c[1],d[0],d[1]);e.create(this._digCallback),this._corridors.push(e)}},ROT.Map.Uniform.prototype._digCallback=function(a,b,c){this._map[a][b]=c,0==c&&this._dug++},ROT.Map.Uniform.prototype._isWallCallback=function(a,b){return!(a<0||b<0||a>=this._width||b>=this._height)&&1==this._map[a][b]},ROT.Map.Uniform.prototype._canBeDugCallback=function(a,b){return!(a<1||b<1||a+1>=this._width||b+1>=this._height)&&1==this._map[a][b]},ROT.Map.Rogue=function(a,b,c){ROT.Map.call(this,a,b),this._options={cellWidth:3,cellHeight:3};for(var d in c)this._options[d]=c[d];this._options.hasOwnProperty("roomWidth")||(this._options.roomWidth=this._calculateRoomSize(this._width,this._options.cellWidth)),this._options.hasOwnProperty("roomHeight")||(this._options.roomHeight=this._calculateRoomSize(this._height,this._options.cellHeight))},ROT.Map.Rogue.extend(ROT.Map),ROT.Map.Rogue.prototype.create=function(a){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),a)for(var b=0;b<this._width;b++)for(var c=0;c<this._height;c++)a(b,c,this.map[b][c]);return this},ROT.Map.Rogue.prototype._calculateRoomSize=function(a,b){var c=Math.floor(a/b*.8),d=Math.floor(a/b*.25);return d<2&&(d=2),c<2&&(c=2),[d,c]},ROT.Map.Rogue.prototype._initRooms=function(){for(var a=0;a<this._options.cellWidth;a++){this.rooms.push([]);for(var b=0;b<this._options.cellHeight;b++)this.rooms[a].push({x:0,y:0,width:0,height:0,connections:[],cellx:a,celly:b})}},ROT.Map.Rogue.prototype._connectRooms=function(){var a,b,c,d,e,f=ROT.RNG.getUniformInt(0,this._options.cellWidth-1),g=ROT.RNG.getUniformInt(0,this._options.cellHeight-1),h=!1;do{var i=[0,2,4,6];i=i.randomize();do if(h=!1,a=i.pop(),b=f+ROT.DIRS[8][a][0],c=g+ROT.DIRS[8][a][1],!(b<0||b>=this._options.cellWidth||c<0||c>=this._options.cellHeight)){if(d=this.rooms[f][g],d.connections.length>0&&d.connections[0][0]==b&&d.connections[0][1]==c)break;e=this.rooms[b][c],0==e.connections.length&&(e.connections.push([f,g]),this.connectedCells.push([b,c]),f=b,g=c,h=!0)}while(i.length>0&&0==h)}while(i.length>0)},ROT.Map.Rogue.prototype._connectUnconnectedRooms=function(){var a=this._options.cellWidth,b=this._options.cellHeight;this.connectedCells=this.connectedCells.randomize();for(var c,d,e,f=0;f<this._options.cellWidth;f++)for(var g=0;g<this._options.cellHeight;g++)if(c=this.rooms[f][g],
0==c.connections.length){var h=[0,2,4,6];h=h.randomize(),e=!1;do{var i=h.pop(),j=f+ROT.DIRS[8][i][0],k=g+ROT.DIRS[8][i][1];if(!(j<0||j>=a||k<0||k>=b)){if(d=this.rooms[j][k],e=!0,0==d.connections.length)break;for(var l=0;l<d.connections.length;l++)if(d.connections[l][0]==f&&d.connections[l][1]==g){e=!1;break}if(e)break}}while(h.length);e?c.connections.push([d.cellx,d.celly]):console.log("-- Unable to connect room.")}},ROT.Map.Rogue.prototype._createRandomRoomConnections=function(a){},ROT.Map.Rogue.prototype._createRooms=function(){for(var a,b,c,d,e,f=this._width,g=this._height,h=this._options.cellWidth,i=this._options.cellHeight,j=Math.floor(this._width/h),k=Math.floor(this._height/i),l=this._options.roomWidth,m=this._options.roomHeight,n=0;n<h;n++)for(var o=0;o<i;o++){if(c=j*n,d=k*o,0==c&&(c=1),0==d&&(d=1),a=ROT.RNG.getUniformInt(l[0],l[1]),b=ROT.RNG.getUniformInt(m[0],m[1]),o>0)for(e=this.rooms[n][o-1];d-(e.y+e.height)<3;)d++;if(n>0)for(e=this.rooms[n-1][o];c-(e.x+e.width)<3;)c++;for(var p=Math.round(ROT.RNG.getUniformInt(0,j-a)/2),q=Math.round(ROT.RNG.getUniformInt(0,k-b)/2);c+p+a>=f;)p?p--:a--;for(;d+q+b>=g;)q?q--:b--;c+=p,d+=q,this.rooms[n][o].x=c,this.rooms[n][o].y=d,this.rooms[n][o].width=a,this.rooms[n][o].height=b;for(var r=c;r<c+a;r++)for(var s=d;s<d+b;s++)this.map[r][s]=0}},ROT.Map.Rogue.prototype._getWallPosition=function(a,b){var c,d,e;return 1==b||3==b?(c=ROT.RNG.getUniformInt(a.x+1,a.x+a.width-2),1==b?(d=a.y-2,e=d+1):(d=a.y+a.height+1,e=d-1),this.map[c][e]=0):2!=b&&4!=b||(d=ROT.RNG.getUniformInt(a.y+1,a.y+a.height-2),2==b?(c=a.x+a.width+1,e=c-1):(c=a.x-2,e=c+1),this.map[e][d]=0),[c,d]},ROT.Map.Rogue.prototype._drawCorridor=function(a,b){var c,d,e,f,g=b[0]-a[0],h=b[1]-a[1],i=a[0],j=a[1],k=[],l=Math.abs(g),m=Math.abs(h),n=ROT.RNG.getUniform(),o=n,p=1-n;for(d=g>0?2:6,e=h>0?4:0,l<m?(c=Math.ceil(m*o),k.push([e,c]),k.push([d,l]),c=Math.floor(m*p),k.push([e,c])):(c=Math.ceil(l*o),k.push([d,c]),k.push([e,m]),c=Math.floor(l*p),k.push([d,c])),this.map[i][j]=0;k.length>0;)for(f=k.pop();f[1]>0;)i+=ROT.DIRS[8][f[0]][0],j+=ROT.DIRS[8][f[0]][1],this.map[i][j]=0,f[1]=f[1]-1},ROT.Map.Rogue.prototype._createCorridors=function(){for(var a,b,c,d,e,f=this._options.cellWidth,g=this._options.cellHeight,h=0;h<f;h++)for(var i=0;i<g;i++){a=this.rooms[h][i];for(var j=0;j<a.connections.length;j++)b=a.connections[j],c=this.rooms[b[0]][b[1]],c.cellx>a.cellx?(d=2,e=4):c.cellx<a.cellx?(d=4,e=2):c.celly>a.celly?(d=3,e=1):c.celly<a.celly&&(d=1,e=3),this._drawCorridor(this._getWallPosition(a,d),this._getWallPosition(c,e))}},ROT.Map.Feature=function(){},ROT.Map.Feature.prototype.isValid=function(a){},ROT.Map.Feature.prototype.create=function(a){},ROT.Map.Feature.prototype.debug=function(){},ROT.Map.Feature.createRandomAt=function(a,b,c,d,e){},ROT.Map.Feature.Room=function(a,b,c,d,e,f){this._x1=a,this._y1=b,this._x2=c,this._y2=d,this._doors={},arguments.length>4&&this.addDoor(e,f)},ROT.Map.Feature.Room.extend(ROT.Map.Feature),ROT.Map.Feature.Room.createRandomAt=function(a,b,c,d,e){var f=e.roomWidth[0],g=e.roomWidth[1],h=ROT.RNG.getUniformInt(f,g),f=e.roomHeight[0],g=e.roomHeight[1],i=ROT.RNG.getUniformInt(f,g);if(1==c){var j=b-Math.floor(ROT.RNG.getUniform()*i);return new this(a+1,j,a+h,j+i-1,a,b)}if(c==-1){var j=b-Math.floor(ROT.RNG.getUniform()*i);return new this(a-h,j,a-1,j+i-1,a,b)}if(1==d){var k=a-Math.floor(ROT.RNG.getUniform()*h);return new this(k,b+1,k+h-1,b+i,a,b)}if(d==-1){var k=a-Math.floor(ROT.RNG.getUniform()*h);return new this(k,b-i,k+h-1,b-1,a,b)}throw new Error("dx or dy must be 1 or -1")},ROT.Map.Feature.Room.createRandomCenter=function(a,b,c){var d=c.roomWidth[0],e=c.roomWidth[1],f=ROT.RNG.getUniformInt(d,e),d=c.roomHeight[0],e=c.roomHeight[1],g=ROT.RNG.getUniformInt(d,e),h=a-Math.floor(ROT.RNG.getUniform()*f),i=b-Math.floor(ROT.RNG.getUniform()*g),j=h+f-1,k=i+g-1;return new this(h,i,j,k)},ROT.Map.Feature.Room.createRandom=function(a,b,c){var d=c.roomWidth[0],e=c.roomWidth[1],f=ROT.RNG.getUniformInt(d,e),d=c.roomHeight[0],e=c.roomHeight[1],g=ROT.RNG.getUniformInt(d,e),h=a-f-1,i=b-g-1,j=1+Math.floor(ROT.RNG.getUniform()*h),k=1+Math.floor(ROT.RNG.getUniform()*i),l=j+f-1,m=k+g-1;return new this(j,k,l,m)},ROT.Map.Feature.Room.prototype.addDoor=function(a,b){return this._doors[a+","+b]=1,this},ROT.Map.Feature.Room.prototype.getDoors=function(a){for(var b in this._doors){var c=b.split(",");a(parseInt(c[0]),parseInt(c[1]))}return this},ROT.Map.Feature.Room.prototype.clearDoors=function(){return this._doors={},this},ROT.Map.Feature.Room.prototype.addDoors=function(a){for(var b=this._x1-1,c=this._x2+1,d=this._y1-1,e=this._y2+1,f=b;f<=c;f++)for(var g=d;g<=e;g++)f!=b&&f!=c&&g!=d&&g!=e||a(f,g)||this.addDoor(f,g);return this},ROT.Map.Feature.Room.prototype.debug=function(){console.log("room",this._x1,this._y1,this._x2,this._y2)},ROT.Map.Feature.Room.prototype.isValid=function(a,b){for(var c=this._x1-1,d=this._x2+1,e=this._y1-1,f=this._y2+1,g=c;g<=d;g++)for(var h=e;h<=f;h++)if(g==c||g==d||h==e||h==f){if(!a(g,h))return!1}else if(!b(g,h))return!1;return!0},ROT.Map.Feature.Room.prototype.getRandomPosition=function(){return[getRandom(this._x1,this._x2),getRandom(this._y1,this._y2)]},ROT.Map.Feature.Room.prototype.create=function(a){for(var b=this._x1-1,c=this._x2+1,d=this._y1-1,e=this._y2+1,f=0,g=b;g<=c;g++)for(var h=d;h<=e;h++)f=g+","+h in this._doors?2:g==b||g==c||h==d||h==e?1:0,a(g,h,f)},ROT.Map.Feature.Room.prototype.getCenter=function(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]},ROT.Map.Feature.Room.prototype.getLeft=function(){return this._x1},ROT.Map.Feature.Room.prototype.getRight=function(){return this._x2};ROT.Map.Feature.Room.prototype.getTop=function(){return this._y1};ROT.Map.Feature.Room.prototype.getBottom=function(){return this._y2},ROT.Map.Feature.Corridor=function(a,b,c,d){this._startX=a,this._startY=b,this._endX=c,this._endY=d,this._endsWithAWall=!0},ROT.Map.Feature.Corridor.extend(ROT.Map.Feature),ROT.Map.Feature.Corridor.createRandomAt=function(a,b,c,d,e){var f=e.corridorLength[0],g=e.corridorLength[1],h=ROT.RNG.getUniformInt(f,g);return new this(a,b,a+c*h,b+d*h)},ROT.Map.Feature.Corridor.prototype.debug=function(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)},ROT.Map.Feature.Corridor.prototype.isValid=function(a,b){var c=this._startX,d=this._startY,e=this._endX-c,f=this._endY-d,g=1+Math.max(Math.abs(e),Math.abs(f));e&&(e/=Math.abs(e)),f&&(f/=Math.abs(f));for(var h=f,i=-e,j=!0,k=0;k<g;k++){var l=c+k*e,m=d+k*f;if(b(l,m)||(j=!1),a(l+h,m+i)||(j=!1),a(l-h,m-i)||(j=!1),!j){g=k,this._endX=l-e,this._endY=m-f;break}}if(0==g)return!1;if(1==g&&a(this._endX+e,this._endY+f))return!1;var n=!a(this._endX+e+h,this._endY+f+i),o=!a(this._endX+e-h,this._endY+f-i);return this._endsWithAWall=a(this._endX+e,this._endY+f),!n&&!o||!this._endsWithAWall},ROT.Map.Feature.Corridor.prototype.create=function(a){var b=this._startX,c=this._startY,d=this._endX-b,e=this._endY-c,f=1+Math.max(Math.abs(d),Math.abs(e));d&&(d/=Math.abs(d)),e&&(e/=Math.abs(e));for(var g=0;g<f;g++){var h=b+g*d,i=c+g*e;a(h,i,0)}return!0},ROT.Map.Feature.Corridor.prototype.createPriorityWalls=function(a){if(this._endsWithAWall){var b=this._startX,c=this._startY,d=this._endX-b,e=this._endY-c;d&&(d/=Math.abs(d)),e&&(e/=Math.abs(e));var f=e,g=-d;a(this._endX+d,this._endY+e),a(this._endX+f,this._endY+g),a(this._endX-f,this._endY-g)}},ROT.Noise=function(){},ROT.Noise.prototype.get=function(a,b){},ROT.Noise.Simplex=function(a){ROT.Noise.call(this),this._F2=.5*(Math.sqrt(3)-1),this._G2=(3-Math.sqrt(3))/6,this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];for(var b=[],c=a||256,d=0;d<c;d++)b.push(d);b=b.randomize(),this._perms=[],this._indexes=[];for(var d=0;d<2*c;d++)this._perms.push(b[d%c]),this._indexes.push(this._perms[d]%this._gradients.length)},ROT.Noise.Simplex.extend(ROT.Noise),ROT.Noise.Simplex.prototype.get=function(a,b){var c,d,e,f=this._perms,g=this._indexes,h=f.length/2,i=this._G2,j=0,k=0,l=0,m=(a+b)*this._F2,n=Math.floor(a+m),o=Math.floor(b+m),p=(n+o)*i,q=n-p,r=o-p,s=a-q,t=b-r;s>t?(d=1,e=0):(d=0,e=1);var u=s-d+i,v=t-e+i,w=s-1+2*i,x=t-1+2*i,y=n.mod(h),z=o.mod(h),A=.5-s*s-t*t;if(A>=0){A*=A,c=g[y+f[z]];var B=this._gradients[c];j=A*A*(B[0]*s+B[1]*t)}var C=.5-u*u-v*v;if(C>=0){C*=C,c=g[y+d+f[z+e]];var B=this._gradients[c];k=C*C*(B[0]*u+B[1]*v)}var D=.5-w*w-x*x;if(D>=0){D*=D,c=g[y+1+f[z+1]];var B=this._gradients[c];l=D*D*(B[0]*w+B[1]*x)}return 70*(j+k+l)},ROT.FOV=function(a,b){this._lightPasses=a,this._options={topology:8};for(var c in b)this._options[c]=b[c]},ROT.FOV.prototype.compute=function(a,b,c,d){},ROT.FOV.prototype._getCircle=function(a,b,c){var d,e,f,g=[];switch(this._options.topology){case 4:e=1,f=[0,1],d=[ROT.DIRS[8][7],ROT.DIRS[8][1],ROT.DIRS[8][3],ROT.DIRS[8][5]];break;case 6:d=ROT.DIRS[6],e=1,f=[-1,1];break;case 8:d=ROT.DIRS[4],e=2,f=[-1,1]}for(var h=a+f[0]*c,i=b+f[1]*c,j=0;j<d.length;j++)for(var k=0;k<c*e;k++)g.push([h,i]),h+=d[j][0],i+=d[j][1];return g},ROT.FOV.DiscreteShadowcasting=function(a,b){ROT.FOV.call(this,a,b)},ROT.FOV.DiscreteShadowcasting.extend(ROT.FOV),ROT.FOV.DiscreteShadowcasting.prototype.compute=function(a,b,c,d){this._coords,this._map;if(d(a,b,0,1),this._lightPasses(a,b))for(var e,f,g,h,i,j=[],k=1;k<=c;k++)for(var l=this._getCircle(a,b,k),m=360/l.length,n=0;n<l.length;n++)if(g=l[n][0],h=l[n][1],e=m*(n-.5),f=e+m,i=!this._lightPasses(g,h),this._visibleCoords(Math.floor(e),Math.ceil(f),i,j)&&d(g,h,k,1),2==j.length&&0==j[0]&&360==j[1])return},ROT.FOV.DiscreteShadowcasting.prototype._visibleCoords=function(a,b,c,d){if(a<0){var e=arguments.callee(0,b,c,d),f=arguments.callee(360+a,360,c,d);return e||f}for(var g=0;g<d.length&&d[g]<a;)g++;if(g==d.length)return c&&d.push(a,b),!0;var h=0;if(g%2){for(;g<d.length&&d[g]<b;)g++,h++;return 0!=h&&(c&&(h%2?d.splice(g-h,h,b):d.splice(g-h,h)),!0)}for(;g<d.length&&d[g]<b;)g++,h++;return(a!=d[g-h]||1!=h)&&(c&&(h%2?d.splice(g-h,h,a):d.splice(g-h,h,a,b)),!0)},ROT.FOV.PreciseShadowcasting=function(a,b){ROT.FOV.call(this,a,b)},ROT.FOV.PreciseShadowcasting.extend(ROT.FOV),ROT.FOV.PreciseShadowcasting.prototype.compute=function(a,b,c,d){if(d(a,b,0,1),this._lightPasses(a,b))for(var e,f,g,h,i,j,k=[],l=1;l<=c;l++)for(var m=this._getCircle(a,b,l),n=m.length,o=0;o<n;o++)if(e=m[o][0],f=m[o][1],h=[o?2*o-1:2*n-1,2*n],i=[2*o+1,2*n],g=!this._lightPasses(e,f),j=this._checkVisibility(h,i,g,k),j&&d(e,f,l,j),2==k.length&&0==k[0][0]&&k[1][0]==k[1][1])return},ROT.FOV.PreciseShadowcasting.prototype._checkVisibility=function(a,b,c,d){if(a[0]>b[0]){var e=this._checkVisibility(a,[a[1],a[1]],c,d),f=this._checkVisibility([0,1],b,c,d);return(e+f)/2}for(var g=0,h=!1;g<d.length;){var i=d[g],j=i[0]*a[1]-a[0]*i[1];if(j>=0){0!=j||g%2||(h=!0);break}g++}for(var k=d.length,l=!1;k--;){var i=d[k],j=b[0]*i[1]-i[0]*b[1];if(j>=0){0==j&&k%2&&(l=!0);break}}var m=!0;if(g==k&&(h||l)?m=!1:h&&l&&g+1==k&&k%2?m=!1:g>k&&g%2&&(m=!1),!m)return 0;var n,o,p=k-g+1;if(p%2)if(g%2){var o=d[g];n=(b[0]*o[1]-o[0]*b[1])/(o[1]*b[1]),c&&d.splice(g,p,b)}else{var o=d[k];n=(o[0]*a[1]-a[0]*o[1])/(a[1]*o[1]),c&&d.splice(g,p,a)}else{if(!(g%2))return c&&d.splice(g,p,a,b),1;var q=d[g],r=d[k];n=(r[0]*q[1]-q[0]*r[1])/(q[1]*r[1]),c&&d.splice(g,p)}var s=(b[0]*a[1]-a[0]*b[1])/(a[1]*b[1]);return n/s},ROT.FOV.RecursiveShadowcasting=function(a,b){ROT.FOV.call(this,a,b)},ROT.FOV.RecursiveShadowcasting.extend(ROT.FOV),ROT.FOV.RecursiveShadowcasting.OCTANTS=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]],ROT.FOV.RecursiveShadowcasting.prototype.compute=function(a,b,c,d){d(a,b,0,1);for(var e=0;e<ROT.FOV.RecursiveShadowcasting.OCTANTS.length;e++)this._renderOctant(a,b,ROT.FOV.RecursiveShadowcasting.OCTANTS[e],c,d)},ROT.FOV.RecursiveShadowcasting.prototype.compute180=function(a,b,c,d,e){e(a,b,0,1);var f=(d-1+8)%8,g=(d-2+8)%8,h=(d+1+8)%8;this._renderOctant(a,b,ROT.FOV.RecursiveShadowcasting.OCTANTS[g],c,e),this._renderOctant(a,b,ROT.FOV.RecursiveShadowcasting.OCTANTS[f],c,e),this._renderOctant(a,b,ROT.FOV.RecursiveShadowcasting.OCTANTS[d],c,e),this._renderOctant(a,b,ROT.FOV.RecursiveShadowcasting.OCTANTS[h],c,e)},ROT.FOV.RecursiveShadowcasting.prototype.compute90=function(a,b,c,d,e){e(a,b,0,1);var f=(d-1+8)%8;this._renderOctant(a,b,ROT.FOV.RecursiveShadowcasting.OCTANTS[d],c,e),this._renderOctant(a,b,ROT.FOV.RecursiveShadowcasting.OCTANTS[f],c,e)},ROT.FOV.RecursiveShadowcasting.prototype._renderOctant=function(a,b,c,d,e){this._castVisibility(a,b,1,1,0,d+1,c[0],c[1],c[2],c[3],e)},ROT.FOV.RecursiveShadowcasting.prototype._castVisibility=function(a,b,c,d,e,f,g,h,i,j,k){if(!(d<e))for(var l=c;l<=f;l++){for(var m=-l-1,n=-l,o=!1,p=0;m<=0;){m+=1;var q=a+m*g+n*h,r=b+m*i+n*j,s=(m-.5)/(n+.5),t=(m+.5)/(n-.5);if(!(t>d)){if(s<e)break;if(m*m+n*n<f*f&&k(q,r,l,1),o){if(!this._lightPasses(q,r)){p=t;continue}o=!1,d=p}else!this._lightPasses(q,r)&&l<f&&(o=!0,this._castVisibility(a,b,l+1,d,s,f,g,h,i,j,k),p=t)}}if(o)break}},ROT.Color={fromString:function(a){var b,c;if(a in this._cache)b=this._cache[a];else{if("#"==a.charAt(0)){var d=a.match(/[0-9a-f]/gi).map(function(a){return parseInt(a,16)});if(3==d.length)b=d.map(function(a){return 17*a});else{for(var e=0;e<3;e++)d[e+1]+=16*d[e],d.splice(e,1);b=d}}else b=(c=a.match(/rgb\(([0-9, ]+)\)/i))?c[1].split(/\s*,\s*/).map(function(a){return parseInt(a)}):[0,0,0];this._cache[a]=b}return b.slice()},add:function(a,b){for(var c=a.slice(),d=0;d<3;d++)for(var e=1;e<arguments.length;e++)c[d]+=arguments[e][d];return c},add_:function(a,b){for(var c=0;c<3;c++)for(var d=1;d<arguments.length;d++)a[c]+=arguments[d][c];return a},multiply:function(a,b){for(var c=a.slice(),d=0;d<3;d++){for(var e=1;e<arguments.length;e++)c[d]*=arguments[e][d]/255;c[d]=Math.round(c[d])}return c},multiply_:function(a,b){for(var c=0;c<3;c++){for(var d=1;d<arguments.length;d++)a[c]*=arguments[d][c]/255;a[c]=Math.round(a[c])}return a},interpolate:function(a,b,c){arguments.length<3&&(c=.5);for(var d=a.slice(),e=0;e<3;e++)d[e]=Math.round(d[e]+c*(b[e]-a[e]));return d},interpolateHSL:function(a,b,c){arguments.length<3&&(c=.5);for(var d=this.rgb2hsl(a),e=this.rgb2hsl(b),f=0;f<3;f++)d[f]+=c*(e[f]-d[f]);return this.hsl2rgb(d)},randomize:function(a,b){b instanceof Array||(b=Math.round(ROT.RNG.getNormal(0,b)));for(var c=a.slice(),d=0;d<3;d++)c[d]+=b instanceof Array?Math.round(ROT.RNG.getNormal(0,b[d])):b;return c},rgb2hsl:function(a){var b,c,d=a[0]/255,e=a[1]/255,f=a[2]/255,g=Math.max(d,e,f),h=Math.min(d,e,f),i=(g+h)/2;if(g==h)b=c=0;else{var j=g-h;switch(c=i>.5?j/(2-g-h):j/(g+h),g){case d:b=(e-f)/j+(e<f?6:0);break;case e:b=(f-d)/j+2;break;case f:b=(d-e)/j+4}b/=6}return[b,c,i]},hsl2rgb:function(a){var b=a[2];if(0==a[1])return b=Math.round(255*b),[b,b,b];var c=function(a,b,c){return c<0&&(c+=1),c>1&&(c-=1),c<1/6?a+6*(b-a)*c:c<.5?b:c<2/3?a+(b-a)*(2/3-c)*6:a},d=a[1],e=b<.5?b*(1+d):b+d-b*d,f=2*b-e,g=c(f,e,a[0]+1/3),h=c(f,e,a[0]),i=c(f,e,a[0]-1/3);return[Math.round(255*g),Math.round(255*h),Math.round(255*i)]},toRGB:function(a){return"rgb("+this._clamp(a[0])+","+this._clamp(a[1])+","+this._clamp(a[2])+")"},toHex:function(a){for(var b=[],c=0;c<3;c++)b.push(this._clamp(a[c]).toString(16).lpad("0",2));return"#"+b.join("")},_clamp:function(a){return a<0?0:a>255?255:a},_cache:{black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}},ROT.Lighting=function(a,b){this._reflectivityCallback=a,this._options={passes:1,emissionThreshold:100,range:10},this._fov=null,this._lights={},this._reflectivityCache={},this._fovCache={},this.setOptions(b)},ROT.Lighting.prototype.setOptions=function(a){for(var b in a)this._options[b]=a[b];return a&&a.range&&this.reset(),this},ROT.Lighting.prototype.setFOV=function(a){return this._fov=a,this._fovCache={},this},ROT.Lighting.prototype.setLight=function(a,b,c){var d=a+","+b;return c?this._lights[d]="string"==typeof c?ROT.Color.fromString(c):c:delete this._lights[d],this},ROT.Lighting.prototype.clearLights=function(){this._lights={}},ROT.Lighting.prototype.reset=function(){return this._reflectivityCache={},this._fovCache={},this},ROT.Lighting.prototype.compute=function(a){var b={},c={},d={};for(var e in this._lights){var f=this._lights[e];c[e]=[0,0,0],ROT.Color.add_(c[e],f)}for(var g=0;g<this._options.passes;g++)this._emitLight(c,d,b),g+1!=this._options.passes&&(c=this._computeEmitters(d,b));for(var h in d){var i=h.split(","),j=parseInt(i[0]),k=parseInt(i[1]);a(j,k,d[h])}return this},ROT.Lighting.prototype._emitLight=function(a,b,c){for(var d in a){var e=d.split(","),f=parseInt(e[0]),g=parseInt(e[1]);this._emitLightFromCell(f,g,a[d],b),c[d]=1}return this},ROT.Lighting.prototype._computeEmitters=function(a,b){var c={};for(var d in a)if(!(d in b)){var e=a[d];if(d in this._reflectivityCache)var f=this._reflectivityCache[d];else{var g=d.split(","),h=parseInt(g[0]),i=parseInt(g[1]),f=this._reflectivityCallback(h,i);this._reflectivityCache[d]=f}if(0!=f){for(var j=[],k=0,l=0;l<3;l++){var m=Math.round(e[l]*f);j[l]=m,k+=m}k>this._options.emissionThreshold&&(c[d]=j)}}return c},ROT.Lighting.prototype._emitLightFromCell=function(a,b,c,d){var e=a+","+b;if(e in this._fovCache)var f=this._fovCache[e];else var f=this._updateFOV(a,b);for(var g in f){var h=f[g];if(g in d)var i=d[g];else{var i=[0,0,0];d[g]=i}for(var j=0;j<3;j++)i[j]+=Math.round(c[j]*h)}return this},ROT.Lighting.prototype._updateFOV=function(a,b){var c=a+","+b,d={};this._fovCache[c]=d;var e=this._options.range,f=function(a,b,c,f){var g=a+","+b,h=f*(1-c/e);0!=h&&(d[g]=h)};return this._fov.compute(a,b,e,f.bind(this)),d},ROT.Path=function(a,b,c,d){this._toX=a,this._toY=b,this._fromX=null,this._fromY=null,this._passableCallback=c,this._options={topology:8};for(var e in d)this._options[e]=d[e];this._dirs=ROT.DIRS[this._options.topology],8==this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])},ROT.Path.prototype.compute=function(a,b,c){},ROT.Path.prototype._getNeighbors=function(a,b){for(var c=[],d=0;d<this._dirs.length;d++){var e=this._dirs[d],f=a+e[0],g=b+e[1];this._passableCallback(f,g)&&c.push([f,g])}return c},ROT.Path.Dijkstra=function(a,b,c,d){ROT.Path.call(this,a,b,c,d),this._computed={},this._todo=[],this._add(a,b,null)},ROT.Path.Dijkstra.extend(ROT.Path),ROT.Path.Dijkstra.prototype.compute=function(a,b,c){var d=a+","+b;if(d in this._computed||this._compute(a,b),d in this._computed)for(var e=this._computed[d];e;)c(e.x,e.y),e=e.prev},ROT.Path.Dijkstra.prototype._compute=function(a,b){for(;this._todo.length;){var c=this._todo.shift();if(c.x==a&&c.y==b)return;for(var d=this._getNeighbors(c.x,c.y),e=0;e<d.length;e++){var f=d[e],g=f[0],h=f[1],i=g+","+h;i in this._computed||this._add(g,h,c)}}},ROT.Path.Dijkstra.prototype._add=function(a,b,c){var d={x:a,y:b,prev:c};this._computed[a+","+b]=d,this._todo.push(d)},ROT.Path.AStar=function(a,b,c,d){ROT.Path.call(this,a,b,c,d),this._todo=[],this._done={},this._fromX=null,this._fromY=null},ROT.Path.AStar.extend(ROT.Path),ROT.Path.AStar.prototype.compute=function(a,b,c){for(this._todo=[],this._done={},this._fromX=a,this._fromY=b,this._add(this._toX,this._toY,null);this._todo.length;){var d=this._todo.shift();if(d.x==a&&d.y==b)break;for(var e=this._getNeighbors(d.x,d.y),f=0;f<e.length;f++){var g=e[f],h=g[0],i=g[1],j=h+","+i;j in this._done||this._add(h,i,d)}}var d=this._done[a+","+b];if(d)for(;d;)c(d.x,d.y),d=d.prev},ROT.Path.AStar.prototype._add=function(a,b,c){var d=this._distance(a,b),e={x:a,y:b,prev:c,g:c?c.g+1:0,h:d};this._done[a+","+b]=e;for(var f=e.g+e.h,g=0;g<this._todo.length;g++){var h=this._todo[g],i=h.g+h.h;if(f<i||f==i&&d<h.h)return void this._todo.splice(g,0,e)}this._todo.push(e)},ROT.Path.AStar.prototype._distance=function(a,b){switch(this._options.topology){case 4:return Math.abs(a-this._fromX)+Math.abs(b-this._fromY);case 6:var c=Math.abs(a-this._fromX),d=Math.abs(b-this._fromY);return d+Math.max(0,(c-d)/2);case 8:return Math.max(Math.abs(a-this._fromX),Math.abs(b-this._fromY))}throw new Error("Illegal topology")};var Weapon=function(a,b,c,d,e,f,g){this._x=f,this._y=g,this._char=b,this._color=c,this._name=a,this._dmg=d,this._price=e,this._draw=function(a){var a=a||Colors.FOV_FLOOR;IsInFOV(this._x,this._y)?RogueJS.display.draw(this._x,this._y,this._char,this._color,a):RogueJS.display.draw(this._x,this._y,RogueJS.map[this._x+","+this._y])},this.act=function(){},this.getX=function(){return this._x},this.getY=function(){return this._y},this.getName=function(){return this._name},this.getChar=function(){return this._char},this.getDamage=function(){return this._dmg},this.getPrice=function(){return this._price},RogueJS.scheduler.add(this)};